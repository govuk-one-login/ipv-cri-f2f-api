AWSTemplateFormatVersion: "2010-09-09"
Transform: "AWS::Serverless-2016-10-31"
Description: "Digital Identity IPV CRI F2F API"

Parameters:
  CodeSigningConfigArn:
    Type: String
    Default: "none"
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
  Environment:
    Description: "The environment type"
    Type: "String"
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
    ConstraintDescription: Ensure environment variable is set to one of dev, build, staging, integration or production.
  PermissionsBoundary:
    Description: "The ARN of the permissions boundary to apply when creating IAM roles"
    Type: String
    Default: "none"
  SecretPrefix:
    Type: String
    Default: "none"
    Description: Secrets name prefix
  VpcStackName:
    Type: String
    Default: "vpc-cri"
    Description: The name of the VPC stack deployed.
  L2DynamoStackName:
    Type: String
    Default: "f2f-cri-ddb"
    Description: The name of the L2 DynamoDB stack deployed.
  L2KMSStackName:
    Type: String
    Default: "f2f-cri-kms"
    Description: The name of the L2 DynamoDB stack deployed.
  DeployAlarmsInDev:
    Description: "Set to the string value `true` to deploy alarms in a DEV environment"
    Type: String
    Default: false
  SupportManualURL:
    Description: "Link to the F2F support manual"
    Type: String
    Default: 'https://govukverify.atlassian.net/wiki/spaces/Kiwi/pages/4371940205/F2F+CRI+Support+Documentation'
  IPVStubStackName:
    Type: String
    Default: "f2f-ipv-stub"
    Description: The name of theIPV stub stack deployed.
  LambdaConcurrency:
    Description: "Reserved concurrency for Lambdas running in non-DEV environments"
    Type: Number
    Default: 20
  LambdaConcurrencyThreshold:
    Description: "Threshold for Reserved concurrency running in non-DEV environments"
    Type: Number
    Default: 16  #80% of Lambda concurrency
  ApplyReservedConcurrencyInDev:
    Description: "Set to true to apply reserved concurrency when deploying in DEV environments"
    Type: String
    Default: "false"
  TestRoleArn:
    Description: "ARN of the role used during pipeline test stage, allowing Lambda invocations. Injected by the deployment pipeline"
    Type: String
    Default: none
  TrafficTestRoleArn:
    Description: "ARN of the role used during pipeline traffic test stage, allowing Lambda invocations. Injected by the deployment pipeline"
    Type: String
    Default: none
  LambdaDeploymentPreference:
    Description: "Specifies the configuration to enable gradual Lambda deployments. This value is picked up from the LambdaCanaryDeployment on the pipeline "
    Type: String
    Default: AllAtOnce

Mappings:
  EnvironmentConfiguration: # This is where you store per-environment settings.
    dev:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
      logretentionindays: 30
      apiTracingEnabled: true
    build:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
      logretentionindays: 30
      apiTracingEnabled: true
    staging:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
      logretentionindays: 30
      apiTracingEnabled: true
    integration:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
      logretentionindays: 30
      apiTracingEnabled: false
    production:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables #pragma: allowlist secret
      logretentionindays: 30
      apiTracingEnabled: false

  PlatformConfiguration:
    dev:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
    build:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
    staging:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
    integration:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
    production:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython

  EnvironmentVariables: # This is all the environment specific environment variables that don't belong in globals.
    dev:
      YOTIBASEURL: "https://f2f-yoti-stub-yotistub.review-o.dev.account.gov.uk"
      YOTISDK: "1f9edc97-c60c-40d7-becb-c1c6a2ec4963"
      ISSUER: 'https://review-o.dev.account.gov.uk'
      DNSSUFFIX: review-o.dev.account.gov.uk
      MESSAGERETENTIONPERIODDAYS: 345600 # Default: 4 days
      TXMAMESSAGERETENTIONPERIODDAYS: 604800 # Default: 7 days
      POSTOFFICESTUBAPI: "https://f2f-post-office-stub-postofficestub.review-o.dev.account.gov.uk"
      GOVUKNOTIFYPDFTEMPLATEID: "bea2a584-4dca-4970-a90d-93977e752fdf"
      GOVUKNOTIFYREMINDERTEMPLATEID: "59cdab0d-3b81-4711-ae47-6cfb80b07f56"
      GOVUKNOTIFYDYNAMICREMINDERTEMPLATEID: "c403df64-adcd-487b-bedf-ae649c80ee5a"
      YOTISESSIONTTLDAYS: 15 # Default 15 days
      RESOURCETTLSECS: 1555200 # Default 18 days
      CLIENTS:
        '[
          {
              "jwksEndpoint":"https://f2f-ipv-stub-ipvstub.review-o.dev.account.gov.uk/.well-known/jwks.json",
              "clientId":"5C584572",
              "redirectUri":"https://f2f-ipv-stub-ipvstub.review-o.dev.account.gov.uk/redirect?id=f2f",
              "YotiBaseUrl": "https://f2f-yoti-stub-yotistub.review-o.dev.account.gov.uk",
              "GovNotifyApi": "https://f2f-gov-notify-stub-govnotifystub.review-o.dev.account.gov.uk/govnotify",
              "OsLocationsApi": "https://api.os.uk/search/places/v1/postcode"
          },
          {
              "jwksEndpoint":"https://f2f-ipv-stub-ipvstub.review-o.dev.account.gov.uk/.well-known/jwks.json",
              "clientId":"SandboxJourneyFlow",
              "redirectUri":"https://f2f-ipv-stub-ipvstub.review-o.dev.account.gov.uk/redirect?id=f2f",
              "YotiBaseUrl": "https://f2f-cri-outbound-proxy-proxy.review-o.dev.account.gov.uk/yoti",
              "GovNotifyApi": "https://api.notifications.service.gov.uk",
              "OsLocationsApi": "https://api.os.uk/search/places/v1/postcode"
          }
        ]'
      AUTHSESSIONTTLSECS: 1814400 # 21 days in seconds
      IPVCOREACCOUNT: arn:aws:iam::130355686670:root
      TESTHARNESSURL: "https://f2f-test-harness-testharness.review-o.dev.account.gov.uk"
    build:
      YOTIBASEURL: "https://yotistub.review-o.build.account.gov.uk"
      YOTISDK: "1f9edc97-c60c-40d7-becb-c1c6a2ec4963"
      ISSUER: 'https://review-o.build.account.gov.uk'
      DNSSUFFIX: review-o.build.account.gov.uk
      MESSAGERETENTIONPERIODDAYS: 345600 # Default: 4 days
      TXMAMESSAGERETENTIONPERIODDAYS: 604800 # Default: 7 days
      POSTOFFICESTUBAPI: "https://postofficestub.review-o.build.account.gov.uk"
      GOVUKNOTIFYPDFTEMPLATEID: "b817746a-5808-4b23-be29-5ce8c1509afb"
      GOVUKNOTIFYREMINDERTEMPLATEID: "59cdab0d-3b81-4711-ae47-6cfb80b07f56"
      GOVUKNOTIFYDYNAMICREMINDERTEMPLATEID: "c403df64-adcd-487b-bedf-ae649c80ee5a"
      YOTISESSIONTTLDAYS: 15 # Default 15 days
      RESOURCETTLSECS: 1814400 # Default 18 days
      CLIENTS:
        '[
          {
              "jwksEndpoint":"https://ipvstub.review-o.build.account.gov.uk/.well-known/jwks.json",
              "clientId":"BD7B2A5D",
              "redirectUri":"https://ipvstub.review-o.build.account.gov.uk/redirect?id=f2f",
              "YotiBaseUrl": "https://yotistub.review-o.build.account.gov.uk",
              "GovNotifyApi": "https://govnotifystub.review-o.build.account.gov.uk/govnotify",
              "OsLocationsApi": "https://api.os.uk/search/places/v1/postcode"
          },
          {
              "jwksEndpoint":"https://ipvstub.review-o.build.account.gov.uk/.well-known/jwks.json",
              "clientId":"SandboxJourneyFlow",
              "redirectUri":"https://ipvstub.review-o.build.account.gov.uk/redirect?id=f2f",
              "YotiBaseUrl": "https://proxy.review-o.build.account.gov.uk/yoti",
              "GovNotifyApi": "https://api.notifications.service.gov.uk",
              "OsLocationsApi": "https://api.os.uk/search/places/v1/postcode"
          }
        ]'
      AUTHSESSIONTTLSECS: 1814400 # 21 days in seconds
      IPVCOREACCOUNT: arn:aws:iam::457601271792:root
      TESTHARNESSURL: "https://testharness.review-o.build.account.gov.uk/"
    staging:
      YOTISDK: "596d953d-2451-46c8-8553-ebb0d1a75698"
      ISSUER: 'https://review-o.staging.account.gov.uk'
      DNSSUFFIX: review-o.staging.account.gov.uk
      MESSAGERETENTIONPERIODDAYS: 345600 # Default: 4 days
      TXMAMESSAGERETENTIONPERIODDAYS: 604800 # Default: 7 days
      GOVUKNOTIFYPDFTEMPLATEID: "b817746a-5808-4b23-be29-5ce8c1509afb"
      GOVUKNOTIFYREMINDERTEMPLATEID: "59cdab0d-3b81-4711-ae47-6cfb80b07f56"
      YOTISESSIONTTLDAYS: 15 # Default 15 days
      RESOURCETTLSECS: 1814400 # Default 18 days
      CLIENTS:
        '[
          {
              "jwksEndpoint":"https://api.identity.staging.account.gov.uk/.well-known/jwks.json",
              "clientId":"03A5A659-17AA-453F-B905-95D2804823D1",
              "redirectUri":"https://identity.staging.account.gov.uk/credential-issuer/callback?id=f2f",
              "YotiBaseUrl": "https://yotistub.review-o.staging.account.gov.uk",
              "GovNotifyApi": "https://api.notifications.service.gov.uk",
              "OsLocationsApi": "https://api.os.uk/search/places/v1/postcode"
          }
        ]'
      AUTHSESSIONTTLSECS: 1814400 # 21 days in seconds
      IPVCOREACCOUNT: arn:aws:iam::335257547869:root
    integration:
      YOTISDK: "cb78093e-0686-4f86-8e7c-ded6117502e8"
      ISSUER: 'https://review-o.integration.account.gov.uk'
      DNSSUFFIX: review-o.integration.account.gov.uk
      MESSAGERETENTIONPERIODDAYS: 345600 # Default: 4 days
      TXMAMESSAGERETENTIONPERIODDAYS: 604800 # Default: 7 days
      GOVUKNOTIFYPDFTEMPLATEID: "b817746a-5808-4b23-be29-5ce8c1509afb"
      GOVUKNOTIFYREMINDERTEMPLATEID: "59cdab0d-3b81-4711-ae47-6cfb80b07f56"
      GOVUKNOTIFYDYNAMICREMINDERTEMPLATEID: "c403df64-adcd-487b-bedf-ae649c80ee5a"
      YOTISESSIONTTLDAYS: 15 # Default 15 days
      RESOURCETTLSECS: 1814400 # Default 18 days
      CLIENTS:
        '[
          {
              "jwksEndpoint":"https://api.identity.integration.account.gov.uk/.well-known/jwks.json",
              "clientId":"AE140E43-1987-4EE8-86CC-BEF19FC9FF3F",
              "redirectUri":"https://identity.integration.account.gov.uk/credential-issuer/callback?id=f2f",
              "YotiBaseUrl": "https://proxy.review-o.integration.account.gov.uk/yoti",
              "GovNotifyApi": "https://api.notifications.service.gov.uk",
              "OsLocationsApi": "https://api.os.uk/search/places/v1/postcode"
          }
        ]'
      AUTHSESSIONTTLSECS: 1814400 # 21 days in seconds
      IPVCOREACCOUNT: arn:aws:iam::991138514218:root
    production:
      YOTISDK: "81402882-b37c-4348-b336-437cdbb232bb"
      ISSUER: 'https://review-o.account.gov.uk'
      DNSSUFFIX: review-o.account.gov.uk
      MESSAGERETENTIONPERIODDAYS: 345600 # Default: 4 days
      TXMAMESSAGERETENTIONPERIODDAYS: 604800 # Default: 7 days
      GOVUKNOTIFYPDFTEMPLATEID: "a1b28aba-2abe-4201-b255-cfd977c9f633"
      GOVUKNOTIFYREMINDERTEMPLATEID: "0d3b9cb6-2c54-4316-865a-933f0f0dfb53"
      GOVUKNOTIFYDYNAMICREMINDERWITHSTEPSTEMPLATEID: "a675cb71-6300-4d7f-a006-a92be6a5c4c1"
      YOTISESSIONTTLDAYS: 15 # Default 15 days
      RESOURCETTLSECS: 1814400 # Default 18 days
      CLIENTS:
        '[
          {
              "jwksEndpoint":"https://api.identity.account.gov.uk/.well-known/jwks.json",
              "clientId":"C910A762-4BB2-400D-8F3D-4D7E6C84E342",
              "redirectUri":"https://identity.account.gov.uk/credential-issuer/callback?id=f2f",
              "YotiBaseUrl": "https://proxy.review-o.account.gov.uk/yoti",
              "GovNotifyApi": "https://api.notifications.service.gov.uk",
              "OsLocationsApi": "https://api.os.uk/search/places/v1/postcode"
          }
        ]'
      AUTHSESSIONTTLSECS: 1814400 # 21 days in seconds
      IPVCOREACCOUNT: arn:aws:iam::075701497069:root
  TxMAAccounts:
    # EVENTS is used to egress to TxMA.
    dev:
      AUDIT: arn:aws:iam::725018305812:root
      EVENTS: arn:aws:iam::248098332657:root
    build:
      AUDIT: arn:aws:iam::761029721660:root
      EVENTS: arn:aws:iam::750703655225:root
    staging:
      AUDIT: arn:aws:iam::778587367904:root
      EVENTS: arn:aws:iam::178023842775:root
    integration:
      AUDIT: arn:aws:iam::423448613278:root
      EVENTS: arn:aws:iam::729485541398:root
    production:
      AUDIT: arn:aws:iam::348043515437:root
      EVENTS: arn:aws:iam::451773080033:root

Conditions:
  CreateDevResources: !Equals
    - !Ref Environment
    - dev
  IsProdLikeEnvironment: !Or
    - !Equals [!Ref Environment, staging]
    - !Equals [!Ref Environment, integration]
    - !Equals [!Ref Environment, production]
  IsNotProdLikeEnvironment: !Not
    - !Condition IsProdLikeEnvironment
  IsPersonalIdentifiableInformationEnvironment: !Or
    - !Equals [!Ref Environment, integration]
    - !Equals [!Ref Environment, production]
  IsOutboundSQSConnected: !Or
    - !Equals [!Ref Environment, staging]
    - !Equals [!Ref Environment, integration]
    - !Equals [!Ref Environment, production]
  IsNotDevelopment: !Or
    - !Equals [ !Ref Environment, build ]
    - !Equals [ !Ref Environment, staging ]
    - !Equals [ !Ref Environment, integration ]
    - !Equals [ !Ref Environment, production ]
  UseCodeSigning:
    Fn::Not:
      - Fn::Equals:
          - !Ref CodeSigningConfigArn
          - "none"
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"
  UseSecretPrefix:
    Fn::Not:
      - Fn::Equals:
          - !Ref SecretPrefix
          - "none"
  DeployAlarms: !Or
    - Condition: IsNotDevelopment
    - !Equals [!Ref DeployAlarmsInDev, true]
  ApplyReservedConcurrency: !Or
    - Condition: IsNotDevelopment
    - !Equals [!Ref ApplyReservedConcurrencyInDev, true]
  AddExpiredSessionFunctionTestRolePermissions: !And
    - Condition: IsNotProdLikeEnvironment
    - !Not [ !Equals [ !Ref TestRoleArn, none ]]
  AddExpiredSessionFunctionTrafficTestRolePermissions: !And
    - Condition: IsNotProdLikeEnvironment
    - !Not [ !Equals [ !Ref TrafficTestRoleArn, none ]]

  UseCanaryDeploymentAlarms: !Not [ !Equals [ !Ref LambdaDeploymentPreference, AllAtOnce ]]

Globals:
  Function:
    Runtime: nodejs20.x
    VpcConfig:
      SecurityGroupIds:
        - !GetAtt LambdaEgressSecurityGroup.GroupId
      SubnetIds:
        - Fn::ImportValue:
            "Fn::Sub": "${VpcStackName}-ProtectedSubnetIdA"
        - Fn::ImportValue:
            "Fn::Sub": "${VpcStackName}-ProtectedSubnetIdB"
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    Layers:
      - !Sub
        - '{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}' #pragma: allowlist secret # or PYTHON_LAYER or JAVA_LAYER
        - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
    Timeout: 30 # seconds
    Tracing: Active
    MemorySize: 1024
    Architectures:
      - arm64
    Environment:
      Variables:
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}' #pragma: allowlist secret
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_CONNECTION_BASE_URL: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}' #pragma: allowlist secret
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_CLUSTER_ID: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}' #pragma: allowlist secret
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}' #pragma: allowlist secret
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_TENANT: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}' #pragma: allowlist secret
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: "true"
        # These should always be alphabetically organised.
        AWS_STACK_NAME: !Sub ${AWS::StackName} # The AWS Stack Name, as passed into the template.
        POWERTOOLS_LOG_LEVEL: !If [IsNotProdLikeEnvironment, "DEBUG", "INFO"] # The LogLevel for the AWS PowerTools LogHelper
        POWERTOOLS_METRICS_NAMESPACE: F2F-CRI # The Metric Namespace for the AWS PowerTools MetricHelper
        RESOURCES_TTL_SECS:
            !FindInMap [EnvironmentVariables, !Ref Environment, RESOURCETTLSECS]
        SESSION_TABLE:
          Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
        CLIENT_CONFIG:
            !FindInMap [ EnvironmentVariables, !Ref Environment, CLIENTS ]
        SECRET_PREFIX: !If [
          UseSecretPrefix,
          !Ref SecretPrefix,
          !Ref AWS::StackName,
        ] # What is this? @TODO
        #  SQS_AUDIT_EVENT_PREFIX: CIC-F2F # The prefix to add to TxMA event messages
    AutoPublishAlias: live

Resources:

  # Log metric filter and alarm for S3 bucket policy changes
  S3BucketActivityEventMetricFilter:
    Type: 'AWS::Logs::MetricFilter'
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref SessionFunctionLogGroup
      FilterPattern: '{ ($.eventSource = s3.amazonaws.com) && (($.eventName = PutBucketAcl) || ($.eventName = PutBucketPolicy) || ($.eventName = PutBucketCors) || ($.eventName = PutBucketLifecycle) || ($.eventName = PutBucketReplication) || ($.eventName = DeleteBucketPolicy) || ($.eventName = DeleteBucketCors) || ($.eventName = DeleteBucketLifecycle) || ($.eventName = DeleteBucketReplication)) }'
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: S3BucketActivityEventChanges

  S3BucketActivityEventErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-S3Bucket-changes"
      AlarmDescription: !Sub "A CloudWatch Alarm that triggers when changes are made to S3 Bucket. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: S3BucketActivityEventChanges
      Namespace: AWS/S3
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  # Log metric filter and alarm for changes to network gateways
  InternetGatewayEventMetricFilter:
    Type: 'AWS::Logs::MetricFilter'
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref SessionFunctionLogGroup
      FilterPattern: '{ ($.eventName = CreateCustomerGateway) || ($.eventName = DeleteCustomerGateway) || ($.eventName = AttachInternetGateway) || ($.eventName = CreateInternetGateway) || ($.eventName = DeleteInternetGateway) || ($.eventName = DetachInternetGateway) }'
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: IGatewayActivityEvent

  InternetGatewayActivityEventErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-IGW-changes"
      AlarmDescription: !Sub "Triggers CloudWatch Alarm when changes are made to an Internet Gateway in a VPC. ${SupportManualURL}"
      MetricName: IGatewayActivityEvent
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: '1'
      ComparisonOperator: GreaterThanOrEqualToThreshold
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      TreatMissingData: notBreaching
  # Log metric filter and alarm for route table changes
  RouteTableChangesMetricFilter:
    Type: 'AWS::Logs::MetricFilter'
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref SessionFunctionLogGroup
      FilterPattern: '{ ($.eventName = AssociateRouteTable) || ($.eventName = CreateRoute) || ($.eventName = CreateRouteTable) || ($.eventName = DeleteRoute) || ($.eventName = DeleteRouteTable) || ($.eventName = ReplaceRoute) || ($.eventName = ReplaceRouteTableAssociation) || ($.eventName = DisassociateRouteTable) }'
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: VPCRouteTableEvent
  RouteTableChangesEventErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-vpc-route-changes"
      AlarmDescription: !Sub "A CloudWatch Alarm that triggers when changes are made to a VPC's Route Table. ${SupportManualURL}"
      MetricName: VpcRouteTableEvent
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Period: 300
      EvaluationPeriods: '1'
      Threshold: '1'
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      TreatMissingData: notBreaching
  # Log metric filter and alarm when changes are made to VPC.
  VpcChangesEventMetricFilter:
    Type: 'AWS::Logs::MetricFilter'
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref SessionFunctionLogGroup
      FilterPattern: '{ ($.eventName = CreateVpc) || ($.eventName = DeleteVpc) || ($.eventName = ModifyVpcAttribute) || ($.eventName = AcceptVpcPeeringConnection) || ($.eventName = CreateVpcPeeringConnection) || ($.eventName = DeleteVpcPeeringConnection) || ($.eventName = RejectVpcPeeringConnection) || ($.eventName = AttachClassicLinkVpc) || ($.eventName = DetachClassicLinkVpc) || ($.eventName = DisableVpcClassicLink) || ($.eventName = EnableVpcClassicLink) }'
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: VpcEventChanges
  VpcChangesEventAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-vpc-changes"
      AlarmDescription: !Sub "A CloudWatch Alarm that triggers when changes are made to a VPC. ${SupportManualURL}"
      MetricName: VpcEventChanges
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Period: 300
      EvaluationPeriods: '1'
      Threshold: '1'
      ComparisonOperator: GreaterThanOrEqualToThreshold
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      TreatMissingData: notBreaching
  # Log metric and alarm when changes are made to AWS Organisations.
  OrganisationChangesEventMetricFilter:
    Type: 'AWS::Logs::MetricFilter'
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref SessionFunctionLogGroup
      FilterPattern: '{ ($.eventSource = organizations.amazonaws.com) && (($.eventName = AcceptHandshake) || ($.eventName = AttachPolicy) || ($.eventName = CreateAccount) || ($.eventName = CreateOrganizationalUnit) || ($.eventName = CreatePolicy) || ($.eventName = DeclineHandshake) || ($.eventName = DeleteOrganization) || ($.eventName = DeleteOrganizationalUnit) || ($.eventName = DeletePolicy) || ($.eventName = DetachPolicy) || ($.eventName = DisablePolicyType) || ($.eventName = EnablePolicyType) || ($.eventName = InviteAccountToOrganization) || ($.eventName = LeaveOrganization) || ($.eventName = MoveAccount) || ($.eventName = RemoveAccountFromOrganization) || ($.eventName = UpdatePolicy) || ($.eventName = UpdateOrganizationalUnit)) }'
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: OrganisationsEventChange
  OrganisationChangesEventAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-organisations-changes"
      AlarmDescription: !Sub "A CloudWatch Alarm that triggers when changes are made to AWS Organisations. ${SupportManualURL}"
      MetricName: OrganisationsEventChange
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Period: 300
      EvaluationPeriods: '1'
      Threshold: '1'
      ComparisonOperator: GreaterThanOrEqualToThreshold
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      TreatMissingData: notBreaching


  LambdaEgressSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: >-
        Permits outbound on port 443 from within the VPC to the internet.
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow to the wider internet on port 443
          FromPort: 443
          IpProtocol: tcp
          ToPort: 443
      VpcId:
        Fn::ImportValue: !Sub "${VpcStackName}-VpcId"

  JsonWebKeysBucket:
    Type: "AWS::S3::Bucket"
    DeletionPolicy: Delete
    Properties:
      BucketName: !Sub ${AWS::StackName}-jwks-f2f-${Environment}
      VersioningConfiguration:
        Status: "Enabled"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  JWKSBucketRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
        Version: 2012-10-17
      Policies:
        - PolicyName: AccessJWKSjson
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:Get*"
                Resource:
                  - !Sub "arn:aws:s3:::${JsonWebKeysBucket}/.well-known/jwks.json"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  YotiLetterBucket:
    Type: "AWS::S3::Bucket"
    DeletionPolicy: Delete
    Properties:
      BucketName: !Sub ${AWS::StackName}-yotiletter-f2f-${Environment}
      VersioningConfiguration:
        Status: "Enabled"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  ### Start of API Gateway definition.

  F2FRestApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      OpenApiVersion: 3.0.1
      AlwaysDeploy: true
      AccessLogSetting:
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip": "$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path": "$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLength":"$context.responseLength",
          "responseLatency":"$context.responseLatency",
          "integrationLatency":"$context.integrationLatency"
          }
        DestinationArn: !GetAtt F2FAPIGatewayAccessLogGroup.Arn
      EndpointConfiguration:
        Type: REGIONAL
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: './f2f-spec.yaml'
        OpenApiVersion: 3.0.1
      MethodSettings:
        - LoggingLevel: INFO
          MetricsEnabled: true
          ThrottlingBurstLimit: 400
          ThrottlingRateLimit: 200
          # Disable data trace in production and integration to avoid logging customer sensitive information
          DataTraceEnabled: !If
            - IsPersonalIdentifiableInformationEnvironment
            - false
            - true
          HttpMethod: "*"
          ResourcePath: "/*"
      TracingEnabled: true
      Tags:
        Product: GOV.UK Sign In
        System: F2F
        Environment: !Ref Environment
        Service: backend
        Name: F2FRestApi
        Source: alphagov/di-devplatform-demo-sam-app/sam-app/template.yaml
        FMSRegionalPolicy: false
        CustomPolicy: true

  F2FAPIGatewayAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]
      Tags:
        - Key: Product
          Value: GOV.UK Sign In
        - Key: System
          Value: Dev Platform
        - Key: Environment
          Value: Demo
        - Key: Service
          Value: backend
        - Key: Name
          Value: APIGatewayAccessLogGroup

  ### End of API Gateway definition.

  WAFv2ACLAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      ResourceArn: !Sub "arn:aws:apigateway:${AWS::Region}::/restapis/${F2FRestApi}/stages/${F2FRestApi.Stage}"
      WebACLArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Security/Block/WafArn}}"

  ### API Gateway Custom Domain definition

  F2FApiCustomDomainName:
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: !If
        - CreateDevResources
        - !Sub
          - "api-${AWS::StackName}.${DNSSUFFIX}"
          - DNSSUFFIX:
              !FindInMap [ EnvironmentVariables, !Ref Environment, DNSSUFFIX ]
        - !Sub
          - "api.${DNSSUFFIX}"
          - DNSSUFFIX:
             !FindInMap [ EnvironmentVariables, !Ref Environment, DNSSUFFIX ]

      EndpointConfiguration:
        Types:
          - REGIONAL
      RegionalCertificateArn: !Sub "{{resolve:ssm:/${Environment}/Platform/ACM/PrimaryZoneWildcardCertificateARN}}"
      SecurityPolicy: TLS_1_2

  F2FApiBasePath:
    Type: AWS::ApiGateway::BasePathMapping
    DependsOn: "F2FApiCustomDomainName"
    Properties:
      DomainName: !Ref F2FApiCustomDomainName
      RestApiId: !Ref F2FRestApi
      Stage: !Sub "${F2FRestApi.Stage}"

  F2FApiCertificateRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: !Ref F2FApiCustomDomainName
      Type: A
      HostedZoneId: !Sub "{{resolve:ssm:/${Environment}/Platform/Route53/PrimaryZoneID}}"
      AliasTarget:
        DNSName: !GetAtt F2FApiCustomDomainName.RegionalDomainName
        HostedZoneId: !GetAtt F2FApiCustomDomainName.RegionalHostedZoneId

  F2FRestAPIFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref F2FAPIGatewayAccessLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "F2FResetAPI-Fatalerror"

  F2FRestAPIFatalErrorAlarm:
    DependsOn:
      - "F2FRestAPIFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-F2FRestAPI-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: F2FResetAPI-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  ### End of API Gateway Custom Domain definition

  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codedeploy.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRoleForLambda
      PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]

  ### Function Definition

####################################################################
#                                                                  #
# Session Function                                                 #
#                                                                  #
####################################################################

  SessionFunction:
    Type: AWS::Serverless::Function
    DependsOn: SessionFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-Session-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref SessionFunctionFatalErrorAlarm, !Ref SessionFunctionLambdaErrors, !Ref SessionFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      Handler: SessionHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          AUTH_SESSION_TTL_SECS:
            !FindInMap [EnvironmentVariables, !Ref Environment, AUTHSESSIONTTLSECS]
          POWERTOOLS_SERVICE_NAME: SessionHandler
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
          PERSON_IDENTITY_TABLE_NAME:
            Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
          KMS_KEY_ARN:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
          ENCRYPTION_KEY_IDS:
            Fn::ImportValue: !Sub "${L2KMSStackName}-encryption-key"
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Sid: KMSPolicy
              Effect: Allow
              Action:
                - kms:*
              Resource:
                "*"
              #Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
              #Resource: !Sub "arn:aws:kms:eu-west-2:060113405249:key/ff437a51-ec7e-4118-9c95-7b0bb2856836"
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt TxMASQSQueue.Arn
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt TxMAKMSEncryptionKey.Arn
      Events:
        session:
          Type: Api
          Properties:
            Path: /session
            Method: post
            RestApiId: !Ref F2FRestApi

    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - SessionHandler.ts

  SessionFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-Session-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  SessionFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn:
        !FindInMap [ PlatformConfiguration, !Ref Environment, CSLSEGRESS ]
      FilterPattern: ""
      LogGroupName: !Ref SessionFunctionLogGroup

  SessionFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SessionFunction
      Principal: apigateway.amazonaws.com

  SessionFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref SessionFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "SessionFunction-Fatalerror"

  SessionFunctionFatalErrorAlarm:
    DependsOn:
      - "SessionFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-SessionFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: SessionFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  SessionFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-SessionFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-SessionFunction:live"
        - Name: ExecutedVersion
          Value: !Sub SessionFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  SessionFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-SessionFunctionCanary5xxErrors"
      AlarmDescription: !Sub SessionFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: POST
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /session
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  SessionConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of Session is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-SessionFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref SessionFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  SessionThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${SessionFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-SessionFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref SessionFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  VerifyAuthorizeRequestMessageCodeMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref SessionFunctionLogGroup
      FilterPattern: "{ $.messageCode =* }"
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "VerifyAuthorizeRequest-lambda-messageCode"
          Dimensions:
            - Key: MessageCode
              Value: $.messageCode

  VerifyAuthorizeRequestFailedVerifyingJwtLowThresholdAlarm:
    DependsOn:
      - "VerifyAuthorizeRequestMessageCodeMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-VerifyAuthorizeRequestFailedVerifyingJwtLowThresholdAlarm"
      AlarmDescription: !Sub "There has been an error verifying the JWT using the RP's public key. This is likely an issue with the RP. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: error
          ReturnData: true
          MetricStat:
            Metric:
              Namespace: !Sub "${AWS::StackName}/LogMessages"
              MetricName: VerifyAuthorizeRequest-lambda-messageCode
              Dimensions:
                - Name: MessageCode
                  Value: FAILED_VERIFYING_JWT
            Period: 60
            Stat: Sum

  VerifyAuthorizeRequestFailedVerifyingJwtCriticalAlarm:
    DependsOn:
      - "VerifyAuthorizeRequestMessageCodeMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-VerifyAuthorizeRequestFailedVerifyingJwtCriticalAlarm"
      AlarmDescription: !Sub "There has been an error verifying the JWT using the RP's public key. This is likely an issue with the RP. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 5
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: error
          ReturnData: true
          MetricStat:
            Metric:
              Namespace: !Sub "${AWS::StackName}/LogMessages"
              MetricName: VerifyAuthorizeRequest-lambda-messageCode
              Dimensions:
                - Name: MessageCode
                  Value: FAILED_VERIFYING_JWT
            Period: 300
            Stat: Sum


####################################################################
#                                                                  #
# Session Config Function                                          #
#                                                                  #
####################################################################

  SessionConfigFunction:
    Type: AWS::Serverless::Function
    DependsOn: SessionConfigFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-SessionConfig-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref SessionConfigFunctionFatalErrorAlarm, !Ref SessionConfigFunctionLambdaErrors, !Ref SessionConfigFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      Handler: SessionConfigHandler.lambdaHandler
      CodeUri: ../src/
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: SessionConfigHandler
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"

        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-key-id"
      Events:
        session:
          Type: Api
          Properties:
            Path: /sessionConfiguration
            Method: get
            RestApiId: !Ref F2FRestApi

    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - SessionConfigHandler.ts

  SessionConfigFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-SessionConfig-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  SessionConfigFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn:
        !FindInMap [ PlatformConfiguration, !Ref Environment, CSLSEGRESS ]
      FilterPattern: ""
      LogGroupName: !Ref SessionConfigFunctionLogGroup

  SessionConfigFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SessionConfigFunction
      Principal: apigateway.amazonaws.com

  SessionConfigFunctionFatalErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref SessionConfigFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "SessionConfigFunction-Fatalerror"

  SessionConfigFunctionFatalErrorAlarm:
    DependsOn:
      - "SessionConfigFunctionFatalErrorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-SessionConfigFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: false
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: SessionConfigFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  SessionConfigFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-SessionConfigFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-SessionConfigFunction:live"
        - Name: ExecutedVersion
          Value: !Sub SessionConfigFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  SessionConfigFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-SessionConfigFunctionCanary5xxErrors"
      AlarmDescription:  !Sub SessionConfigFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: GET
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /sessionConfiguration
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching


  SessionConfigConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      AlarmDescription: !Sub "Trigger the alarm if over 80% of Session is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-SessionConfigFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref SessionConfigFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  SessionConfigThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      AlarmDescription: !Sub "Trigger if the ${SessionConfigFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-SessionConfigFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref SessionConfigFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Access Token Function                                            #
#                                                                  #
####################################################################

  TokenFunction:
    Type: AWS::Serverless::Function
    DependsOn: TokenFunctionLogGroup
    Properties:
      FunctionName: !Sub "Access-Token-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref TokenFunctionFatalErrorAlarm, !Ref TokenFunctionCanary5xxErrors, !Ref TokenFunctionLambdaErrors]
          - [!Ref AWS::NoValue]
      Handler: AccessTokenHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: AccessTokenHandler
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
          KMS_KEY_ARN:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
          DNSSUFFIX: !FindInMap [ EnvironmentVariables, !Ref Environment, DNSSUFFIX ]
          CLIENT_CONFIG: !FindInMap [ EnvironmentVariables, !Ref Environment, CLIENTS ]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Sid: KMSPolicy
              Effect: Allow
              Action:
                - kms:Sign
              Resource:
                Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
      Events:
        userInfo:
          Type: Api
          Properties:
            Path: /token
            Method: post
            RestApiId: !Ref F2FRestApi
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - AccessTokenHandler.ts

  TokenFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/Access-Token-${AWS::StackName}"
      RetentionInDays: !FindInMap [ EnvironmentConfiguration, !Ref Environment, logretentionindays ]

  TokenFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
   # Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref TokenFunctionLogGroup

  TokenFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref TokenFunction
      Principal: apigateway.amazonaws.com

  TokenFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref TokenFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "TokenFunction-Fatalerror"

  TokenFunctionFatalErrorAlarm:
    DependsOn:
      - "TokenFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-TokenFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: TokenFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  TokenFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-TokenFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-TokenFunction:live"
        - Name: ExecutedVersion
          Value: !Sub TokenFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  TokenFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-TokenFunctionCanary5xxErrors"
      AlarmDescription:  !Sub TokenFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: POST
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /token
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  TokenConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of Token concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-TokenFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref TokenFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  TokenThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${TokenFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-TokenFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref TokenFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Authorization Function                                           #
#                                                                  #
####################################################################

  AuthorizationFunction:
    Type: AWS::Serverless::Function
    DependsOn: AuthorizationFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-Authorization-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref AuthorizationFunctionFatalErrorAlarm, !Ref AuthorizationFunctionCanary5xxErrors, !Ref AuthorizationFunctionLambdaErrors]
          - [!Ref AWS::NoValue]
      Handler: AuthorizationCodeHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: AuthorizationCodeHandler
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt TxMASQSQueue.Arn
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt TxMAKMSEncryptionKey.Arn
      Events:
        authorization:
          Type: Api
          Properties:
            Path: /authorization
            Method: get
            RestApiId: !Ref F2FRestApi

    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - AuthorizationCodeHandler.ts

  AuthorizationFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-Authorization-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  AuthorizationFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    # Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref AuthorizationFunctionLogGroup

  AuthorizationFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AuthorizationFunction
      Principal: apigateway.amazonaws.com

  AuthorizationFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref AuthorizationFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "AuthorizationFunction-Fatalerror"

  AuthorizationFunctionFatalErrorAlarm:
    DependsOn:
      - "AuthorizationFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: AuthorizationFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AuthorizationFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-AuthorizationFunction:live"
        - Name: ExecutedVersion
          Value: !Sub AuthorizationFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AuthorizationFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunctionCanary5xxErrors"
      AlarmDescription:  !Sub AuthorizationFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: GET
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /authorization
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AuthorizationConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of authorization concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref AuthorizationFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AuthorizationThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${AuthorizationFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-AuthorizationFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref AuthorizationFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Document Selection Function                                      #
#                                                                  #
####################################################################

  DocumentSelectionFunction:
    Type: AWS::Serverless::Function
    DependsOn: DocumentSelectionLogGroup
    Properties:
      FunctionName: !Sub "Document-Selection-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref DocumentSelectionFatalErrorAlarm, !Ref DocumentSelectionFunctionLambdaErrors, !Ref DocumentSelectionFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      Handler: DocumentSelectionHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: DocumentSelectionHandler
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
          AUTH_SESSION_TTL_SECS:
            !FindInMap [EnvironmentVariables, !Ref Environment, AUTHSESSIONTTLSECS]
          PERSON_IDENTITY_TABLE_NAME:
            Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
          YOTICALLBACKURL: !If
            - CreateDevResources
            - !Sub
              - "https://api-${AWS::StackName}.${DNSSUFFIX}/callback"
              - DNSSUFFIX:
                  !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
            - !Sub
              - "https://api.${DNSSUFFIX}/callback"
              - DNSSUFFIX:
                  !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
          GOV_NOTIFY_QUEUE_URL: !Ref GovNotifySQSQueue
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
          YOTI_KEY_SSM_PATH: !Sub "/${Environment}/YOTI/PRIVATEKEY"
          YOTISDK: !FindInMap [EnvironmentVariables, !Ref Environment, YOTISDK]
          YOTI_SESSION_TTL_DAYS:
            !FindInMap [EnvironmentVariables, !Ref Environment, YOTISESSIONTTLDAYS] 
          YOTI_LETTER_STATE_MACHINE_ARN: !GetAtt SendYotiLetterStateMachine.Arn
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/YOTI/PRIVATEKEY"
        - DynamoDBReadPolicy:
            TableName: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-person-identity-table-name"
        - DynamoDBWritePolicy:
            TableName: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-person-identity-table-name"
        - DynamoDBReadPolicy:
            TableName: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-name"
        - DynamoDBWritePolicy:
            TableName: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-person-identity-table-key-id"
        - KMSDecryptPolicy:
            KeyId: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt [TxMASQSQueue, Arn]
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt [TxMAKMSEncryptionKey, Arn]
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt [GovNotifySQSQueue, Arn]
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt [GovNotifyEncryptionKey, Arn]
        -  Statement:
              - Effect: Allow
                Action:
                  - "states:StartExecution"
                Resource: !GetAtt SendYotiLetterStateMachine.Arn
      Events:
        documentSelection:
          Type: Api
          Properties:
            Path: /documentSelection
            Method: post
            RestApiId: !Ref F2FRestApi
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - DocumentSelectionHandler.ts

  DocumentSelectionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/Document-Selection-${AWS::StackName}"
      RetentionInDays: !FindInMap [ EnvironmentConfiguration, !Ref Environment, logretentionindays ]

  DocumentSelectionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    # Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref DocumentSelectionLogGroup

  DocumentSelectionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref DocumentSelectionFunction
      Principal: apigateway.amazonaws.com

  DocumentSelectionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref DocumentSelectionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "DocumentSelection-Fatalerror"

  DocumentSelectionFatalErrorAlarm:
    DependsOn:
      - "DocumentSelectionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DocumentSelection-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: DocumentSelection-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  DocumentSelectionFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DocumentSelectionFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-DocumentSelectionFunction:live"
        - Name: ExecutedVersion
          Value: !Sub DocumentSelectionFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  DocumentSelectionFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-DocumentSelectionFunctionCanary5xxErrors"
      AlarmDescription: !Sub DocumentSelectionFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: POST
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /documentSelection
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  DocumentSelectionConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of Document selection concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-DocumentSelectionFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref DocumentSelectionFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  DocumentSelectionThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${DocumentSelectionFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-DocumentSelectionFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref DocumentSelectionFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Abort Function                                                   #
#                                                                  #
####################################################################

  AbortFunction:
    Type: AWS::Serverless::Function
    DependsOn: AbortLogGroup
    Properties:
      FunctionName: !Sub "Abort-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref AbortFunctionFatalErrorAlarm, !Ref AbortFunctionLambdaErrors, !Ref AbortFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      Handler: AbortHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: AbortHandler
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBWritePolicy:
            TableName: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt [TxMASQSQueue, Arn]
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt [TxMAKMSEncryptionKey, Arn]
      Events:
        abort:
          Type: Api
          Properties:
            Path: /abort
            Method: post
            RestApiId: !Ref F2FRestApi
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - AbortHandler.ts

  AbortLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/Abort-${AWS::StackName}"
      RetentionInDays: !FindInMap [ EnvironmentConfiguration, !Ref Environment, logretentionindays ]

  AbortLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    # Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref AbortLogGroup

  AbortFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref AbortLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "AbortFunction-Fatalerror"

  AbortFunctionFatalErrorAlarm:
    DependsOn:
      - "AbortFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AbortFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: AbortFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AbortFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AbortFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-AbortFunction:live"
        - Name: ExecutedVersion
          Value: !Sub AbortFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AbortFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-AbortFunctionCanary5xxErrors"
      AlarmDescription: !Sub AbortFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: POST
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /abort
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching


  AbortPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AbortFunction
      Principal: apigateway.amazonaws.com

  ## PersonInfoHandler
  PersonInfoFunction:
    Type: AWS::Serverless::Function
    DependsOn: PersonInfoFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-person-info-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref PersonInfoFunctionFatalErrorAlarm, !Ref PersonInfoFunctionLambdaErrors, !Ref PersonInfoFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      Handler: PersonInfoHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: PersonInfoHandler
          PRIVATE_KEY_SSM_PATH: !Sub "/${Environment}/person-info/PRIVATE_KEY"
          PERSON_IDENTITY_TABLE_NAME:
            Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/person-info/PRIVATE_KEY"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-key-id"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Sid: KMSPolicy
              Effect: Allow
              Action:
                - kms:*
              Resource:
                "*"
      Events:
        personInfo:
          Type: Api
          Properties:
            Path: /person-info
            Method: get
            RestApiId: !Ref F2FRestApi

    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false
        EntryPoints:
          - PersonInfoHandler.ts

  PersonInfoFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-person-info-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  PersonInfoFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn:
        !FindInMap [ PlatformConfiguration, !Ref Environment, CSLSEGRESS ]
      FilterPattern: ""
      LogGroupName: !Ref PersonInfoFunctionLogGroup

  PersonInfoFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref PersonInfoFunction
      Principal: apigateway.amazonaws.com

  PersonInfoFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref PersonInfoFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "PersonInfoFunction-Fatalerror"

  PersonInfoFunctionFatalErrorAlarm:
    DependsOn:
      - "PersonInfoFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PersonInfoFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: PersonInfoFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  PersonInfoFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PersonInfoFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-PersonInfoFunction:live"
        - Name: ExecutedVersion
          Value: !Sub PersonInfoFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  PersonInfoFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-PersonInfoFunctionCanary5xxErrors"
      AlarmDescription: !Sub PersonInfoFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: GET
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /person-info
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching


  PersonInfoConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of PersonInfo is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-PersonInfoFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref PersonInfoFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  PersonInfoThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${PersonInfoFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-PersonInfoFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref PersonInfoFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  PersonInfo5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PersonInfo5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the PersonInfo endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: GET
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /person-info
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: GET
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /person-info
            Period: 60
            Stat: Sum

  PersonInfo5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PersonInfo5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the PersonInfo endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: GET
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /person-info
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: GET
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /person-info
            Period: 60
            Stat: Sum

  PersonInfo4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PersonInfo4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the PersonInfo endpoint. ${SupportManualURL}"
      ActionsEnabled: false   # alarm reviewed in production and decision made to disable
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 10
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<3 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /person-info
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /person-info
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum

  ## PersonInfoKeyHandler
  PersonInfoKeyFunction:
    Type: AWS::Serverless::Function
    DependsOn: PersonInfoKeyFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-person-info-key-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref PersonInfoKeyFunctionFatalErrorAlarm, !Ref PersonInfoKeyFunctionLambdaErrors, !Ref PersonInfoKeyFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      Handler: PersonInfoKeyHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: PersonInfoKeyHandler
          PRIVATE_KEY_SSM_PATH: !Sub "/${Environment}/person-info/PRIVATE_KEY"
          KMS_KEY_ARN:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/person-info/PRIVATE_KEY"
      Events:
        personInfoKey:
          Type: Api
          Properties:
            Path: /person-info-key
            Method: get
            RestApiId: !Ref F2FRestApi

    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false
        EntryPoints:
          - PersonInfoKeyHandler.ts

  PersonInfoKeyFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-person-info-key-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  PersonInfoKeyFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref PersonInfoKeyFunction
      Principal: apigateway.amazonaws.com

  PersonInfoKeyFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref PersonInfoKeyFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "PersonInfoKeyFunction-Fatalerror"

  PersonInfoKeyFunctionFatalErrorAlarm:
    DependsOn:
      - "PersonInfoKeyFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PersonInfoKeyFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: PersonInfoKeyFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  PersonInfoKeyFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-PersonInfoKeyFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-PersonInfoKeyFunction:live"
        - Name: ExecutedVersion
          Value: !Sub PersonInfoKeyFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  PersonInfoKeyFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-PersonInfoKeyFunctionCanary5xxErrors"
      AlarmDescription: !Sub PersonInfoKeyFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: GET
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /person-info-key
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  PersonInfoKeyConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of PersonInfoKey is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-PersonInfoKeyFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref PersonInfoKeyFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  PersonInfoKeyThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${PersonInfoKeyFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-PersonInfoKeyFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref PersonInfoKeyFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  ## AddressLocationsHandler
  AddressLocationsFunction:
    Type: AWS::Serverless::Function
    DependsOn: AddressLocationsFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-addressLocations-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref AddressLocationsFunctionFatalErrorAlarm, !Ref AddressLocationsFunctionLambdaErrors, !Ref AddressLocationsFunctionCanary5xxErrors]
          - [!Ref AWS::NoValue]
      Handler: AddressLocationsHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: AddressLocationsHandler
          OS_API_KEY_SSM_PATH: !Sub "/${Environment}/ordnance-survey/API_KEY"
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/ordnance-survey/API_KEY"
        - KMSDecryptPolicy:
            KeyId: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Sid: KMSPolicy
              Effect: Allow
              Action:
                - kms:*
              Resource:
                "*"
      Events:
        AddressLocations:
          Type: Api
          Properties:
            Path: /addressLocations
            Method: post
            RestApiId: !Ref F2FRestApi

    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false
        EntryPoints:
          - AddressLocationsHandler.ts

  AddressLocationsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-addressLocations-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  AddressLocationsFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AddressLocationsFunction
      Principal: apigateway.amazonaws.com

  AddressLocationsFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref AddressLocationsFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "AddressLocationsFunction-Fatalerror"

  AddressLocationsFunctionFatalErrorAlarm:
    DependsOn:
      - "AddressLocationsFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AddressLocationsFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: AddressLocationsFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AddressLocationsFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-AddressLocationsFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-AddressLocationsFunction:live"
        - Name: ExecutedVersion
          Value: !Sub AddressLocationsFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AddressLocationsFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-AddressLocationsFunctionCanary5xxErrors"
      AlarmDescription: !Sub AddressLocationsFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: GET
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /addressLocations
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AddressLocationsFunctionConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of AddressLocations is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-AddressLocationsFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref AddressLocationsFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  AddressLocationsFunctionThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${AddressLocationsFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-AddressLocationsFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref AddressLocationsFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  ## TXMA SQS Queue
  TxMASQSQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: !FindInMap [EnvironmentVariables, !Ref Environment, TXMAMESSAGERETENTIONPERIODDAYS]
      VisibilityTimeout: 60
      KmsMasterKeyId: !Ref TxMAKeyAlias
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - "TxMASQSQueueDeadLetterQueue"
            - "Arn"
        maxReceiveCount: 5

  TxMASQSQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref TxMASQSQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:ChangeMessageVisibility"
              - "sqs:ReceiveMessage"
            Resource:
              - !GetAtt TxMASQSQueue.Arn
            Principal:
              AWS: !If
                - IsOutboundSQSConnected
                - !FindInMap [TxMAAccounts, !Ref Environment, EVENTS]
                - !Ref AWS::NoValue

  TxMASQSQueueDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 259200 # three days
      KmsMasterKeyId: !Sub TxMAKMSEncryptionKey

  TxMAKMSEncryptionKey:
    Type: AWS::KMS::Key
    # KMS Key manually rotated.
    # checkov:skip=CKV_AWS_7: KMS Key manually rotated.
    Properties:
      Description: A KMS Key for encrypting the SQS Queue for TxMA
      Enabled: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource:
              - "*"
          - Effect: Allow
            Principal:
              AWS: !FindInMap [TxMAAccounts, !Ref Environment, EVENTS]
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource:
              - "*"
      KeySpec: SYMMETRIC_DEFAULT
      KeyUsage: ENCRYPT_DECRYPT
      MultiRegion: false
      PendingWindowInDays: 7
      Tags:
        - Key: KeyType
          Value: Encryption Key
        - Key: Environment
          Value: !Sub ${Environment}

  TxMAKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !If
        - CreateDevResources
        - !Sub "alias/TxMAKMSEncryptionKey-${AWS::StackName}"
        - alias/TxMAKMSEncryptionKey
      TargetKeyId: !Ref TxMAKMSEncryptionKey

####################################################################
#                                                                  #
# JWKS Function                                                    #
#                                                                  #
####################################################################

  JsonWebKeysFunction:
    Type: AWS::Serverless::Function
    DependsOn:
      - "JsonWebKeysLogGroup"
    Properties:
      FunctionName: !Sub "JsonWebKeys-${AWS::StackName}"
      CodeUri: ../src/
      Handler: JwksHandler.lambdaHandler
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Policies:
        - AWSXRayDaemonWriteAccess
        - S3WritePolicy:
            BucketName: !Ref JsonWebKeysBucket
        - S3ReadPolicy:
            BucketName: !Ref JsonWebKeysBucket
        - Statement:
            - Sid: KMSSignPolicy
              Effect: Allow
              Action:
                - kms:GetPublicKey
              Resource:
                - Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
                - Fn::ImportValue: !Sub "${L2KMSStackName}-encryption-key"
      Events:
        InvocationLevel:
          Type: Schedule
          Properties:
            Schedule: cron(0 * * * ? *)

      Environment:
        Variables:
          JWKS_BUCKET_NAME: !Ref JsonWebKeysBucket
          SIGNING_KEY_IDS:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
          ENCRYPTION_KEY_IDS:
            Fn::ImportValue: !Sub "${L2KMSStackName}-encryption-key"
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - JwksHandler.ts

  JsonWebKeysLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/JsonWebKeys-${AWS::StackName}"
      RetentionInDays: !FindInMap [ EnvironmentConfiguration, !Ref Environment, logretentionindays ]

  JsonWebKeysFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt JsonWebKeysFunction.Arn
      Principal: events.amazonaws.com

  JsonWebKeysFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref JsonWebKeysLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "JsonWebKeysFunction-Fatalerror"

  JsonWebKeysFunctionFatalErrorAlarm:
    DependsOn:
      - "JsonWebKeysFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-JsonWebKeysFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: JsonWebKeysFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  JsonWebKeysConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of JsonWeb Keys concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-JsonWebKeysFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref JsonWebKeysFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  JsonWebKeysThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${JsonWebKeysFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-JsonWebKeysFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref JsonWebKeysFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# GovNotify Function                                               #
#                                                                  #
####################################################################

  GovNotifyFunction:
    Type: AWS::Serverless::Function
    DependsOn: GovNotifyFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-GovNotify-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref GovNotifyFunctionFatalErrorAlarm, !Ref GovNotifyFunctionLambdaErrors]
          - [!Ref AWS::NoValue]
      Handler: GovNotifyHandler.lambdaHandler
      CodeUri: ../src/
      Timeout: 300
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: GovNotifyHandler
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
          GOVUKNOTIFY_PDF_TEMPLATE_ID: !FindInMap [ EnvironmentVariables, !Ref Environment, GOVUKNOTIFYPDFTEMPLATEID ]
          GOVUKNOTIFY_REMINDER_TEMPLATE_ID: 
              !FindInMap [ EnvironmentVariables, !Ref Environment, GOVUKNOTIFYREMINDERTEMPLATEID ]
          GOVUKNOTIFY_DYNAMIC_REMINDER_TEMPLATE_ID:
              !FindInMap [ EnvironmentVariables, !Ref Environment, GOVUKNOTIFYDYNAMICREMINDERTEMPLATEID ]
          YOTI_KEY_SSM_PATH: !Sub "/${Environment}/YOTI/PRIVATEKEY"
          GOVUKNOTIFY_API_KEY_SSM_PATH: !Sub "/${Environment}/f2f-gov-notify/GOVUKNOTIFY_API_KEY_ENCRYPTED"
          YOTISDK: !FindInMap [ EnvironmentVariables, !Ref Environment, YOTISDK ]
          YOTI_SESSION_TTL_DAYS:             
            !FindInMap [ EnvironmentVariables, !Ref Environment, YOTISESSIONTTLDAYS ]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/YOTI/PRIVATEKEY"
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/f2f-gov-notify/GOVUKNOTIFY_API_KEY_ENCRYPTED"
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt TxMASQSQueue.Arn
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt TxMAKMSEncryptionKey.Arn
            - Effect: Allow
              Action:
                - "kms:Decrypt"
              Resource: !GetAtt GovNotifyEncryptionKey.Arn
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt GovNotifySQSQueue.Arn
            BatchSize: 1
            Enabled: true
            FunctionResponseTypes:
              - ReportBatchItemFailures
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - GovNotifyHandler.ts

  GovNotifyFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-GovNotify-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  GovNotifyFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref GovNotifyFunctionLogGroup

  GovNotifyFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GovNotifyFunction
      Principal: apigateway.amazonaws.com

  GovNotifyFunctionPermissionAlias:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GovNotifyFunction.Alias
      Principal: apigateway.amazonaws.com

  GovNotifyFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref GovNotifyFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "GovNotifyFunction-Fatalerror"

  GovNotifyFunctionFatalErrorAlarm:
    DependsOn:
      - "GovNotifyFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-GovNotifyFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: GovNotifyFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  GovNotifyFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-GovNotifyFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-GovNotifyFunction:live"
        - Name: ExecutedVersion
          Value: !Sub GovNotifyFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  GovNotifyConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of GovNotify concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-GovNotifyFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref GovNotifyFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

####################################################################
#                                                                  #
# UserInfo Function                                                #
#                                                                  #
####################################################################

  UserInfoFunction:
    Type: AWS::Serverless::Function
    DependsOn: UserInfoFunctionLogGroup
    Properties:
      FunctionName: !Sub "User-Info-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref UserInfoFunctionFatalErrorAlarm, !Ref UserInfoFunctionCanary5xxErrors, !Ref UserInfoFunctionLambdaErrors]
          - [!Ref AWS::NoValue]
      Handler: UserInfoHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: UserInfoHandler
          KMS_KEY_ARN:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Sid: KMSPolicy
              Effect: Allow
              Action:
                - kms:Verify
              Resource:
                Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt TxMASQSQueue.Arn
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt TxMAKMSEncryptionKey.Arn
      Events:
        userInfo:
          Type: Api
          Properties:
            Path: /userinfo
            Method: post
            RestApiId: !Ref F2FRestApi
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - UserInfoHandler.ts

  UserInfoFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/User-Info-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  UserInfoFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    # Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [ PlatformConfiguration, !Ref Environment, CSLSEGRESS ]
      FilterPattern: ""
      LogGroupName: !Ref UserInfoFunctionLogGroup

  UserInfoFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref UserInfoFunction
      Principal: apigateway.amazonaws.com

  UserInfoFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref UserInfoFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "UserInfoFunction-Fatalerror"

  UserInfoFunctionFatalErrorAlarm:
    DependsOn:
      - "UserInfoFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-UserInfoFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: UserInfoFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  UserInfoFunctionLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-UserInfoFunctionLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-UserInfoFunction:live"
        - Name: ExecutedVersion
          Value: !Sub UserInfoFunction.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  UserInfoFunctionCanary5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmName: !Sub "${AWS::StackName}-UserInfoFunctionCanary5xxErrors"
      AlarmDescription: !Sub UserInfoFunction Lambda returning 5xx response. ${SupportManualURL}
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: Method
          Value: POST
        - Name: ApiName
          Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
        - Name: Stage
          Value: !Ref Environment
        - Name: Resource
          Value: /userinfo
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 3
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching


  UserInfoConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of UserInfro concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-UserInfoFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref UserInfoFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  UserInfoThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${UserInfoFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-UserInfoFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref UserInfoFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Reminder Email Function                                          #
#                                                                  #
####################################################################

  ReminderEmailFunction:
    Type: AWS::Serverless::Function
    DependsOn: ReminderEmailFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-ReminderEmail-${AWS::StackName}"
      Handler: ReminderEmailHandler.lambdaHandler
      CodeUri: ../src/
      Timeout: 900
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: ReminderEmailHandler
          GOV_NOTIFY_QUEUE_URL: !Ref GovNotifySQSQueue
          PERSON_IDENTITY_TABLE_NAME:
            Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
          KMS_KEY_ARN:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
          ENCRYPTION_KEY_IDS:
            Fn::ImportValue: !Sub "${L2KMSStackName}-encryption-key"
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-person-identity-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-person-identity-table-key-id"
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt [GovNotifySQSQueue, Arn]
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt [GovNotifyEncryptionKey, Arn]
      Events:
        ScheduledEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 * * * ? *)


    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - ReminderEmailHandler.ts

  ReminderEmailFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-ReminderEmail-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  ReminderEmailFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn:
        !FindInMap [ PlatformConfiguration, !Ref Environment, CSLSEGRESS ]
      FilterPattern: ""
      LogGroupName: !Ref ReminderEmailFunctionLogGroup

  ReminderEmailFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ReminderEmailFunction
      Principal: apigateway.amazonaws.com

  ReminderEmailFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ReminderEmailFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "ReminderEmailFunction-Fatalerror"

  ReminderEmailFunctionFatalErrorAlarm:
    DependsOn:
      - "ReminderEmailFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ReminderEmailFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ReminderEmailFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  ReminderEmailConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of ReminderEmail is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-ReminderEmailFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref ReminderEmailFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  ReminderEmailThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${ReminderEmailFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-ReminderEmailFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref ReminderEmailFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Expired Sessions Function                                        #
#                                                                  #
####################################################################

  ExpiredSessionsFunction:
    Type: AWS::Serverless::Function
    DependsOn: ExpiredSessionsFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-ExpiredSessions-${AWS::StackName}"
      Handler: ExpiredSessionsHandler.lambdaHandler
      CodeUri: ../src/
      Timeout: 900
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: ExpiredSessionsHandler
          KMS_KEY_ARN:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
          ENCRYPTION_KEY_IDS:
            Fn::ImportValue: !Sub "${L2KMSStackName}-encryption-key"
          AUTH_SESSION_TTL_SECS:
            !FindInMap [EnvironmentVariables, !Ref Environment, AUTHSESSIONTTLSECS]
          YOTI_SESSION_TTL_DAYS:             
            !FindInMap [EnvironmentVariables, !Ref Environment, YOTISESSIONTTLDAYS]
          IPV_CORE_QUEUE_URL: !Ref IPVCoreSQSQueue
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
          - Effect: Allow
            Action:
              - "sqs:SendMessage"
            Resource: !GetAtt IPVCoreSQSQueue.Arn
          - Effect: Allow
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: !GetAtt IPVCoreQueueEncryptionKey.Arn
      Events:
        ScheduledEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/15 * * * ? *)


    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - ExpiredSessionsHandler.ts

  ExpiredSessionsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-ExpiredSessions-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  ExpiredSessionsFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn:
        !FindInMap [ PlatformConfiguration, !Ref Environment, CSLSEGRESS ]
      FilterPattern: ""
      LogGroupName: !Ref ExpiredSessionsFunctionLogGroup

  ExpiredSessionsFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ExpiredSessionsFunction
      Principal: apigateway.amazonaws.com


  ExpiredSessionFunctionTestRolePermission:
    Type: AWS::Lambda::Permission
    Condition: AddExpiredSessionFunctionTestRolePermissions
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ExpiredSessionsFunction
      Principal: !Ref TestRoleArn

  ExpiredSessionFunctionTrafficTestRolePermission:
    Type: AWS::Lambda::Permission
    Condition: AddExpiredSessionFunctionTrafficTestRolePermissions
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ExpiredSessionsFunction
      Principal: !Ref TrafficTestRoleArn

  ExpiredSessionsFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ExpiredSessionsFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "ExpiredSessionsFunction-Fatalerror"

  ExpiredSessionsFunctionFatalErrorAlarm:
    DependsOn:
      - "ExpiredSessionsFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ExpiredSessionsFunction-FatalErrorAlarm"
      AlarmDescription: !Sub Trigger an alarm when Fatal Error occurs. ${SupportManualURL}
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ExpiredSessionsFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  #Gov Notify SQS Queue
  GovNotifySQSQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      MessageRetentionPeriod: !FindInMap [EnvironmentVariables, !Ref Environment, MESSAGERETENTIONPERIODDAYS]
      VisibilityTimeout: 1800 #Setting this to 6 times the GovNotify lambda timeout
      KmsMasterKeyId: !Ref GovNotifyKeyAlias
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - "GovNotifySQSQueueDeadLetterQueue"
            - "Arn"
        maxReceiveCount: 2

  GovNotifySQSQueueDeadLetterQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      MessageRetentionPeriod: 259200 # three days
      KmsMasterKeyId: !Sub GovNotifyEncryptionKey

  GovNotifySQSQueuePolicy:
    Type: "AWS::SQS::QueuePolicy"
    Properties:
      Queues:
        - !Ref GovNotifySQSQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "lambda.amazonaws.com"
            Action:
              - "sqs:ReceiveMessage"
              - "sqs:DeleteMessage"
            Resource: !GetAtt GovNotifySQSQueue.Arn

  GovNotifyEncryptionKey:
    Type: AWS::KMS::Key
    # KMS Key manually rotated.
    # checkov:skip=CKV_AWS_7: KMS Key manually rotated.
    Properties:
      Description: A KMS Key for encrypting the SQS Queue for GovNotify
      Enabled: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource:
              - "*"
      KeySpec: SYMMETRIC_DEFAULT
      KeyUsage: ENCRYPT_DECRYPT
      MultiRegion: false
      PendingWindowInDays: 7
      Tags:
        - Key: KeyType
          Value: Encryption Key
        - Key: Environment
          Value: !Sub ${Environment}

  GovNotifyKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !If
        - CreateDevResources
        - !Sub "alias/GovNotifyEncryptionKey-${AWS::StackName}"
        - alias/GovNotifyEncryptionKey
      TargetKeyId: !Ref GovNotifyEncryptionKey

  YotiCallbackStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "F2F-YotiCallback-stepfunction-${AWS::StackName}"
      DefinitionUri: ../src/stepFunctions/yotiCallback.asl.json
      DefinitionSubstitutions:
        YotiSessionCompletionFunctionArn: !GetAtt YotiCallbackFunction.Arn
        ThankYouEmailFunctionArn: !GetAtt ThankYouEmailFunction.Arn
      Policies:
        - AWSXrayWriteOnlyAccess
        - LambdaInvokePolicy:
            FunctionName: !Ref YotiCallbackFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ThankYouEmailFunction
      Tracing:
        Enabled: true
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  TriggerYotiCallbackStateMachine:
    Type: AWS::Serverless::Function
    DependsOn: TriggerYotiCallbackStateMachineLogGroup
    Properties:
      FunctionName: !Sub "F2F-TriggerYotiCallbackStateMachine-${AWS::StackName}"
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Role: !GetAtt CodeDeployServiceRole.Arn
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref TriggerYotiCallbackStateMachineFatalErrorAlarm, !Ref TriggerYotiCallbackStateMachineLambdaErrors]
          - [!Ref AWS::NoValue]
      Handler: TriggerYotiCallbackStateMachineHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: TriggerYotiCallbackStateMachineHandler
          STATE_MACHINE_ARN: !GetAtt YotiCallbackStateMachine.Arn
      Policies:
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/YOTI/PRIVATEKEY"
        - Statement:
            - Effect: Allow
              Action:
                - "kms:Decrypt"
              Resource: !GetAtt YotiCallbackEncryptionKey.Arn
        - Statement:
            - Sid: KMSPolicy
              Effect: Allow
              Action:
                - kms:Verify
                - kms:Sign
              Resource:
                Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
        -  Statement:
              - Effect: Allow
                Action:
                  - "sqs:SendMessage"
                  - "sqs:ReceiveMessage"
                Resource: !GetAtt YotiCallbackQueue.Arn
        -  Statement:
              - Effect: Allow
                Action:
                  - "states:StartExecution"
                Resource: !GetAtt YotiCallbackStateMachine.Arn
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt YotiCallbackQueue.Arn
            BatchSize: 1
            Enabled: true
            FunctionResponseTypes:
              - ReportBatchItemFailures
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - TriggerYotiCallbackStateMachineHandler.ts

  TriggerYotiCallbackStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-TriggerYotiCallbackStateMachine-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  TriggerYotiCallbackStateMachinePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref TriggerYotiCallbackStateMachine
      Principal: apigateway.amazonaws.com

  TriggerYotiCallbackStateMachineFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn:
        !FindInMap [ PlatformConfiguration, !Ref Environment, CSLSEGRESS ]
      FilterPattern: ""
      LogGroupName: !Ref TriggerYotiCallbackStateMachineLogGroup

  TriggerYotiCallbackSMFatalErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref TriggerYotiCallbackStateMachineLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "TriggerYotiCallbackFunction-Fatalerror"

  TriggerYotiCallbackStateMachineFatalErrorAlarm:
    DependsOn:
      - "TriggerYotiCallbackSMFatalErrorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-TriggerYotiCallbackStateMachineFatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: TriggerYotiCallbackFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  TriggerYotiCallbackStateMachineLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-TriggerYotiCallbackStateMachineLambdaErrors"
      AlarmDescription: !Sub Trigger an alarm when lambda errors occurs. ${SupportManualURL}
      ActionsEnabled: false
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-TriggerYotiCallbackStateMachine:live"
        - Name: ExecutedVersion
          Value: !Sub TriggerYotiCallbackStateMachine.Version.Version
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  TriggerYotiConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of Yoticallback is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-TriggerYotiCallbackFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref TokenFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  TriggerYotiThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${TriggerYotiCallbackStateMachine} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-TriggerYotiCallbackStateMachine-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: TriggerYotiCallbackStateMachine
          Value: !Ref TriggerYotiCallbackStateMachine
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  YotiCallbackQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      MessageRetentionPeriod: 1209600 # 14 days in seconds
      VisibilityTimeout: 300
      KmsMasterKeyId: !Ref YotiCallbackKeyAlias
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - "YotiCallbackQueueDeadLetterQueue"
            - "Arn"
        maxReceiveCount: 10

####################################################################
#                                                                  #
# Yoti Callback Function                                           #
#                                                                  #
####################################################################

  YotiCallbackFunction:
    Type: AWS::Serverless::Function
    DependsOn: YotiCallbackFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-YotiCallback-${AWS::StackName}"
      Handler: YotiSessionCompletionHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: YotiSessionCompletionHandler
          PERSON_IDENTITY_TABLE_NAME:
            Fn::ImportValue:
              !Sub "${L2DynamoStackName}-person-identity-table-name"
          YOTISDK: !FindInMap [ EnvironmentVariables, !Ref Environment, YOTISDK ]
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
          YOTI_KEY_SSM_PATH: !Sub "/${Environment}/YOTI/PRIVATEKEY"
          FETCH_YOTI_SESSION_BACKOFF_PERIOD_MS: 5000
          FETCH_YOTI_SESSION_MAX_RETRIES: 3
          KMS_KEY_ARN:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
          DNSSUFFIX: !FindInMap [ EnvironmentVariables, !Ref Environment, DNSSUFFIX ]
          IPV_CORE_QUEUE_URL: !Ref IPVCoreSQSQueue
          YOTI_SESSION_TTL_DAYS:             
            !FindInMap [EnvironmentVariables, !Ref Environment, YOTISESSIONTTLDAYS]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/YOTI/PRIVATEKEY"
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-person-identity-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-person-identity-table-key-id"
        - Statement:
            - Effect: Allow
              Action:
                - "kms:Decrypt"
              Resource: !GetAtt YotiCallbackEncryptionKey.Arn
        - Statement:
            - Sid: KMSPolicy
              Effect: Allow
              Action:
                - kms:Verify
                - kms:Sign
              Resource:
                Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
        - Statement:
          - Effect: Allow
            Action:
              - "sqs:SendMessage"
            Resource: !GetAtt TxMASQSQueue.Arn
          - Effect: Allow
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: !GetAtt TxMAKMSEncryptionKey.Arn
        - Statement:
          - Effect: Allow
            Action:
              - "sqs:SendMessage"
            Resource: !GetAtt IPVCoreSQSQueue.Arn
          - Effect: Allow
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: !GetAtt IPVCoreQueueEncryptionKey.Arn
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - YotiSessionCompletionHandler.ts

  YotiCallbackFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-YotiCallback-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  YotiCallbackFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref YotiCallbackFunctionLogGroup

  YotiCallbackFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref YotiCallbackFunction
      Principal: apigateway.amazonaws.com

####################################################################
#                                                                  #
# ThankYou Email Function                                          #
#                                                                  #
####################################################################

  ThankYouEmailFunction:
    Type: AWS::Serverless::Function
    DependsOn: ThankYouEmailFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-ThankYouEmail-${AWS::StackName}"
      Handler: ThankYouEmailHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: ThankYouEmailHandler
          YOTISDK: !FindInMap [ EnvironmentVariables, !Ref Environment, YOTISDK ]
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
          YOTI_KEY_SSM_PATH: !Sub "/${Environment}/YOTI/PRIVATEKEY"
          FETCH_YOTI_SESSION_BACKOFF_PERIOD_MS: 5000
          FETCH_YOTI_SESSION_MAX_RETRIES: 3
          KMS_KEY_ARN:
            Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/YOTI/PRIVATEKEY"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - Statement:
            - Effect: Allow
              Action:
                - "kms:Decrypt"
              Resource: !GetAtt YotiCallbackEncryptionKey.Arn
        - Statement:
            - Sid: KMSPolicy
              Effect: Allow
              Action:
                - kms:Verify
                - kms:Sign
              Resource:
                Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key"
        - Statement:
          - Effect: Allow
            Action:
              - "sqs:SendMessage"
            Resource: !GetAtt TxMASQSQueue.Arn
          - Effect: Allow
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: !GetAtt TxMAKMSEncryptionKey.Arn
        - Statement:
          - Effect: Allow
            Action:
              - "sqs:SendMessage"
            Resource: !GetAtt IPVCoreSQSQueue.Arn
          - Effect: Allow
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: !GetAtt IPVCoreQueueEncryptionKey.Arn
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - ThankYouEmailHandler.ts

  ThankYouEmailFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-ThankYouEmail-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  ThankYouEmailFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref ThankYouEmailFunctionLogGroup

  ThankYouEmailFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ThankYouEmailFunction
      Principal: apigateway.amazonaws.com

  ThankYouEmailFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref ThankYouEmailFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "ThankYouEmail-Fatalerror"

  ThankYouEmailFatalErrorAlarm:
    DependsOn:
      - "ThankYouEmailFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ThankYouEmail-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ThankYouEmail-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  ThankYouEmailRetriesExceededErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref ThankYouEmailFunctionLogGroup
      FilterPattern: '{ $.level = "ERROR" && $.messageCode = "YOTI_RETRIES_EXCEEDED" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "ThankYouEmail-GetCompletedSessionInfoRetriesExceeded-error"

  ThankYouEmailRetriesExceededErrorAlarm:
    DependsOn:
      - "ThankYouEmailRetriesExceededErrorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ThankYouEmail-YotiCallbackRetriesExceededErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when we are unable to fetch Yoti session after max retries. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ThankYouEmail-GetCompletedSessionInfoRetriesExceeded-error
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  ThankYouEmailConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of ThankYouEmail concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-ThankYouEmailFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref ThankYouEmailFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  ThankYouEmailThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${ThankYouEmailFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-ThankYouEmailFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref ThankYouEmailFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Generate Yoti Letter Function                                    #
#                                                                  #
####################################################################

  GenerateYotiLetterFunction:
    Type: AWS::Serverless::Function
    DependsOn: GenerateYotiLetterFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-GenerateYotiLetter-${AWS::StackName}"
      Handler: GenerateYotiLetterHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: GenerateYotiLetterHandler
          YOTI_LETTER_BUCKET: !Sub ${AWS::StackName}-yotiletter-f2f-${Environment}
          YOTI_PDF_BUCKET_LETTER_FOLDER: pdf
          YOTI_KEY_SSM_PATH: !Sub "/${Environment}/YOTI/PRIVATEKEY"
          YOTISDK: !FindInMap [EnvironmentVariables, !Ref Environment, YOTISDK]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-name"
        - S3WritePolicy:
            BucketName: !Ref YotiLetterBucket
        - S3ReadPolicy:
            BucketName: !Ref YotiLetterBucket
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/YOTI/PRIVATEKEY"
        - KMSDecryptPolicy:
            KeyId: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-key-id"
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - GenerateYotiLetterHandler.ts

  GenerateYotiLetterFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-GenerateYotiLetter-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  GenerateYotiLetterFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref GenerateYotiLetterFunctionLogGroup

  GenerateYotiLetterFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GenerateYotiLetterFunction
      Principal: apigateway.amazonaws.com

  GenerateYotiLetterFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref GenerateYotiLetterFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "GenerateYotiLetter-Fatalerror"

  GenerateYotiLetterFatalErrorAlarm:
    DependsOn:
      - "GenerateYotiLetterFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-GenerateYotiLetter-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: GenerateYotiLetter-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  GenerateYotiLetterConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of GenerateYotiLetter concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-GenerateYotiLetterFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref GenerateYotiLetterFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  GenerateYotiLetterThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${GenerateYotiLetterFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-GenerateYotiLetterFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref GenerateYotiLetterFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Generate Printed Letter Function                                 #
#                                                                  #
####################################################################

  GeneratePrintedLetterFunction:
    Type: AWS::Serverless::Function
    DependsOn: GeneratePrintedLetterFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-GeneratePrintedLetter-${AWS::StackName}"
      Handler: GeneratePrintedLetterHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          PERSON_IDENTITY_TABLE_NAME:
            Fn::ImportValue:
              Fn::Sub: ${L2DynamoStackName}-person-identity-table-name
          POWERTOOLS_SERVICE_NAME: GeneratePrintedLetterHandler
          YOTI_LETTER_BUCKET: !Sub ${AWS::StackName}-yotiletter-f2f-${Environment}
          YOTI_PDF_BUCKET_MERGED_LETTER_FOLDER: merged-pdf
          YOTI_PDF_BUCKET_COVER_LETTER_FOLDER: cover-pdf
          YOTI_PDF_BUCKET_LETTER_FOLDER: pdf
          YOTI_SESSION_TTL_DAYS: !FindInMap [EnvironmentVariables, !Ref Environment, YOTISESSIONTTLDAYS]
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-person-identity-table-name"
        - S3WritePolicy:
            BucketName: !Ref YotiLetterBucket
        - S3ReadPolicy:
            BucketName: !Ref YotiLetterBucket
        - KMSDecryptPolicy:
            KeyId: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-session-table-key-id"
        - KMSDecryptPolicy:
            KeyId: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-person-identity-table-key-id"
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Loader:
          - .ttf=file
          - .png=file
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - GeneratePrintedLetterHandler.ts

  GeneratePrintedLetterFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-GeneratePrintedLetter-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  GeneratePrintedLetterFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref GeneratePrintedLetterFunctionLogGroup

  GeneratePrintedLetterFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GeneratePrintedLetterFunction
      Principal: apigateway.amazonaws.com

  GeneratePrintedLetterFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref GeneratePrintedLetterFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "GeneratePrintedLetter-Fatalerror"

  GeneratePrintedLetterFatalErrorAlarm:
    DependsOn:
      - "GeneratePrintedLetterFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-GeneratePrintedLetter-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: GeneratePrintedLetter-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  GeneratePrintedLetterConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of GeneratePrintedLetter concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-GeneratePrintedLetterFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref GeneratePrintedLetterFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  GeneratePrintedLetterThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${GeneratePrintedLetterFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-GeneratePrintedLetterFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref GeneratePrintedLetterFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# SendToGovNotify Function                                         #
#                                                                  #
####################################################################

  SendToGovNotifyFunction:
    Type: AWS::Serverless::Function
    DependsOn: SendToGovNotifyFunctionLogGroup
    Properties:
      FunctionName: !Sub "F2F-SendToGovNotify-${AWS::StackName}"
      Handler: SendToGovNotifyHandler.lambdaHandler
      CodeUri: ../src/
      ReservedConcurrentExecutions: !If
        - ApplyReservedConcurrency
        - !Ref LambdaConcurrency
        - !Ref AWS::NoValue
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: SendToGovNotifyHandler
          YOTI_LETTER_BUCKET: !Sub ${AWS::StackName}-yotiletter-f2f-${Environment}
          YOTI_PDF_BUCKET_LETTER_FOLDER: pdf
          YOTI_PDF_BUCKET_MERGED_LETTER_FOLDER: merged-pdf
          ISSUER: !FindInMap [EnvironmentVariables, !Ref Environment, ISSUER]
          TXMA_QUEUE_URL: !Ref TxMASQSQueue
          GOVUKNOTIFY_PDF_TEMPLATE_ID: !FindInMap [ EnvironmentVariables, !Ref Environment, GOVUKNOTIFYPDFTEMPLATEID ]
          YOTI_KEY_SSM_PATH: !Sub "/${Environment}/YOTI/PRIVATEKEY"
          GOVUKNOTIFY_API_KEY_SSM_PATH: !Sub "/${Environment}/f2f-gov-notify/GOVUKNOTIFY_API_KEY"
          YOTISDK: !FindInMap [ EnvironmentVariables, !Ref Environment, YOTISDK ]
          YOTI_SESSION_TTL_DAYS: !FindInMap [EnvironmentVariables, !Ref Environment, YOTISESSIONTTLDAYS]
          PERSON_IDENTITY_TABLE_NAME:
            Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSXrayWriteOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/YOTI/PRIVATEKEY"
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${Environment}/f2f-gov-notify/GOVUKNOTIFY_API_KEY"
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-name"
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
        - KMSDecryptPolicy:
            KeyId:
              Fn::ImportValue:
                !Sub "${L2DynamoStackName}-session-table-key-id"
        - KMSDecryptPolicy:
            KeyId: !ImportValue
              Fn::Sub: "${L2DynamoStackName}-person-identity-table-key-id"
        - S3ReadPolicy:
            BucketName: !Sub "${AWS::StackName}-yotiletter-f2f-${Environment}"
        - S3WritePolicy:
            BucketName: !Sub "${AWS::StackName}-yotiletter-f2f-${Environment}"
        - Statement:
            - Effect: Allow
              Action:
                - "sqs:SendMessage"
              Resource: !GetAtt TxMASQSQueue.Arn
            - Effect: Allow
              Action:
                - "kms:Encrypt"
                - "kms:Decrypt"
                - "kms:GenerateDataKey"
              Resource: !GetAtt TxMAKMSEncryptionKey.Arn
            - Effect: Allow
              Action:
                - "kms:Decrypt"
              Resource: !GetAtt GovNotifyEncryptionKey.Arn
      
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: false # Enabling source maps will create the required NODE_OPTIONS environment variables on your lambda function during sam build
        EntryPoints:
          - SendToGovNotifyHandler.ts

  SendToGovNotifyFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/F2F-SendToGovNotify-${AWS::StackName}"
      RetentionInDays:
        !FindInMap [
          EnvironmentConfiguration,
          !Ref Environment,
          logretentionindays,
        ]

  SendToGovNotifyFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsProdLikeEnvironment
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref SendToGovNotifyFunctionLogGroup

  SendToGovNotifyFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SendToGovNotifyFunction
      Principal: apigateway.amazonaws.com

  SendToGovNotifyFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref SendToGovNotifyFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "SendToGovNotify-Fatalerror"

  SendToGovNotifyFatalErrorAlarm:
    DependsOn:
      - "SendToGovNotifyFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-SendToGovNotify-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: SendToGovNotify-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  SendToGovNotifyConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of SendToGovNotify concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-SendToGovNotifyFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref SendToGovNotifyFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  SendToGovNotifyThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${SendToGovNotifyFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-SendToGovNotifyFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref SendToGovNotifyFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

####################################################################
#                                                                  #
# Send Yoti Letter StepFunction                                    #
#                                                                  #
####################################################################

  SendYotiLetterStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "F2F-SendYotiLetter-stepfunction-${AWS::StackName}"
      DefinitionUri: ../src/stepFunctions/sendYotiLetter.asl.json
      DefinitionSubstitutions:
        GenerateYotiLetterFunctionArn: !GetAtt GenerateYotiLetterFunction.Arn
        GeneratePrintedLetterFunctionArn: !GetAtt GeneratePrintedLetterFunction.Arn
        SendToGovNotifyFunctionArn: !GetAtt SendToGovNotifyFunction.Arn
      Policies:
        - AWSXrayWriteOnlyAccess
        - LambdaInvokePolicy:
            FunctionName: !Ref GenerateYotiLetterFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref GeneratePrintedLetterFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref SendToGovNotifyFunction
      Tracing:
        Enabled: true
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  YotiCallbackQueueDeadLetterQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      MessageRetentionPeriod: 259200 # three days
      KmsMasterKeyId: !Sub YotiCallbackEncryptionKey

  YotiCallbackQueueRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: YotiCallbackQueuePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - "sqs:SendMessage"
                Resource: !GetAtt YotiCallbackQueue.Arn
              - Effect: Allow
                Action:
                  - "kms:Encrypt"
                  - "kms:Decrypt"
                  - "kms:GenerateDataKey"
                Resource: !GetAtt YotiCallbackEncryptionKey.Arn
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  YotiCallbackEncryptionKey:
    Type: AWS::KMS::Key
    # KMS Key manually rotated.
    # checkov:skip=CKV_AWS_7: KMS Key manually rotated.
    Properties:
      Description: A KMS Key for encrypting the SQS Queue for YotiCallback
      Enabled: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource:
              - "*"
      KeySpec: SYMMETRIC_DEFAULT
      KeyUsage: ENCRYPT_DECRYPT
      MultiRegion: false
      PendingWindowInDays: 7
      Tags:
        - Key: KeyType
          Value: Encryption Key
        - Key: Environment
          Value: !Sub ${Environment}

  YotiCallbackKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !If
        - CreateDevResources
        - !Sub "alias/YotiCallbackEncryptionKey-${AWS::StackName}"
        - alias/YotiCallbackEncryptionKey
      TargetKeyId: !Ref YotiCallbackEncryptionKey

  YotiCallbackFunctionFatalErorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Condition: DeployAlarms
    Properties:
      LogGroupName: !Ref YotiCallbackFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "YotiCallbackFunction-Fatalerror"

  YotiCallbackFunctionFatalErrorAlarm:
    DependsOn:
      - "YotiCallbackFunctionFatalErorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-YotiCallbackFunction-FatalErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: YotiCallbackFunction-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  YotiCallbackRetriesExceededErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref YotiCallbackFunctionLogGroup
      FilterPattern: '{ $.level = "ERROR" && $.messageCode = "YOTI_RETRIES_EXCEEDED" }'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "YotiCallbackFunction-GetCompletedSessionInfoRetriesExceeded-error"

  YotiCallbackRetriesExceededErrorAlarm:
    DependsOn:
      - "YotiCallbackRetriesExceededErrorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-YotiCallbackFunction-YotiCallbackRetriesExceededErrorAlarm"
      AlarmDescription: !Sub "Trigger an alarm when we are unable to fetch Yoti session after max retries. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: YotiCallbackFunction-GetCompletedSessionInfoRetriesExceeded-error
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: [ ]
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  YotiCallbackConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Condition: "ApplyReservedConcurrency"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if over 80% of Yoticallback concurrency is used. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-YotiCallbackFunction-concurrency"
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Dimensions:
        - Name: FunctionName
          Value: !Ref YotiCallbackFunction
      Statistic: Maximum
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: !Ref LambdaConcurrencyThreshold
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  YotiCallbackThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger if the ${YotiCallbackFunction} lambda throttles. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-YotiCallbackFunction-throttles"
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Dimensions:
        - Name: FunctionName
          Value: !Ref YotiCallbackFunction
      TreatMissingData: notBreaching
      Period: 60 # This is the minimum value for the AWS Namespace
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold

  IPVCoreSQSQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: !FindInMap [EnvironmentVariables, !Ref Environment, MESSAGERETENTIONPERIODDAYS]
      VisibilityTimeout: 60
      KmsMasterKeyId: !Ref IPVCoreQueueKeyAlias
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - "IPVCoreDeadLetterQueue"
            - "Arn"
        maxReceiveCount: 5

  IPVCoreQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref IPVCoreSQSQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
              - "sqs:ChangeMessageVisibility"
              - "sqs:ReceiveMessage"
            Resource:
              - !GetAtt IPVCoreSQSQueue.Arn
            Principal:
              AWS: !If
                - IsOutboundSQSConnected
                - !FindInMap [EnvironmentVariables, !Ref Environment, IPVCOREACCOUNT]
                - !Ref AWS::NoValue

  IPVCoreDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 259200 # three days
      KmsMasterKeyId: !Sub IPVCoreQueueEncryptionKey

  IPVCoreQueueEncryptionKey:
    Type: AWS::KMS::Key
    # KMS Key manually rotated.
    # checkov:skip=CKV_AWS_7: KMS Key manually rotated.
    Properties:
      Description: A KMS Key for encrypting the SQS Queue for IPV Core
      Enabled: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource:
              - "*"
          - Effect: Allow
            Principal:
              AWS: !FindInMap [EnvironmentVariables, !Ref Environment, IPVCOREACCOUNT]
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource:
              - "*"
      KeySpec: SYMMETRIC_DEFAULT
      KeyUsage: ENCRYPT_DECRYPT
      MultiRegion: false
      PendingWindowInDays: 7
      Tags:
        - Key: KeyType
          Value: Encryption Key
        - Key: Environment
          Value: !Sub ${Environment}

  IPVCoreQueueKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !If
        - CreateDevResources
        - !Sub "alias/IPVCoreQueueEncryptionKey-${AWS::StackName}"
        - alias/IPVCoreQueueEncryptionKey
      TargetKeyId: !Ref IPVCoreQueueEncryptionKey

  5XXErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-5XXErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the backend api-gateway. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
            Period: 60
            Stat: Sum

  5XXErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-5XXErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the backend api-gateway. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
            Period: 60
            Stat: Sum

  DocumentSelection5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DocumentSelection5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the DocumentSelection endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /documentSelection
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /documentSelection
            Period: 60
            Stat: Sum

  DocumentSelection5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DocumentSelection5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the DocumentSelection endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /documentSelection
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /documentSelection
            Period: 60
            Stat: Sum

  UserInfo5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-UserInfo5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the UserInfo endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /userinfo
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /userinfo
            Period: 60
            Stat: Sum

  UserInfo5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-UserInfo5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the UserInfo endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /userinfo
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /userinfo
            Period: 60
            Stat: Sum

  Token5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Token5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the Token endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /token
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /token
            Period: 60
            Stat: Sum

  Token5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Token5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the Token endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /token
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /token
            Period: 60
            Stat: Sum

  Authorization5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Authorization5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the Authorization endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /authorization
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /authorization
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum

  Authorization5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Authorization5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the Authorization endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /authorization
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /authorization
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum

  Session5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Session5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the Session endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /session
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /session
            Period: 60
            Stat: Sum

  Session5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Session5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the Session endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /session
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /session
            Period: 60
            Stat: Sum

  JsonWebKeys5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-JsonWebKeys5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the userInfo endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /.well-known/jwks.json
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /.well-known/jwks.json
            Period: 60
            Stat: Sum

  JsonWebKeys5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-JsonWebKeys5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the userInfo endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-pagerduty-alert-topic
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /.well-known/jwks.json
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /.well-known/jwks.json
            Period: 60
            Stat: Sum

  YotiCallback5XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-YotiCallback5XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 5XX errors on the YotiCallback endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<4 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /callback
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /callback
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  YotiCallback5XXApiGwErrorCriticalAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-YotiCallback5XXApiGwErrorCriticalAlarm"
      AlarmDescription: !Sub "There has been a significant proportion of 5XX errors on the YotiCallback endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-critical-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-critical-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<10,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /callback
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 5XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /callback
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  DocumentSelection4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-DocumentSelection4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the DocumentSelection endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<2 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /documentSelection
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: Method
                  Value: POST
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Stage
                  Value: !Ref Environment
                - Name: Resource
                  Value: /documentSelection
            Period: 60
            Stat: Sum

  UserInfo4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-UserInfo4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the UserInfo endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<2 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /userinfo
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /userinfo
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  Token4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Token4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the Token endpoint. ${SupportManualURL}"
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<2 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /token
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /token
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  Authorization4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Authorization4XXApiGwErrorAlarm"
      AlarmDescription:
        Fn::Sub: >-
          >=50% of invocations to the Authorization endpoint have generated a 4XX error in
          4 or more out of the last 10 minutes. ${SupportManualURL}
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 10
      DatapointsToAlarm: 4
      Threshold: 50
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: safePercentage
          Label: safePercentage
          ReturnData: true
          Expression: IF(invocations<5 || error<5,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /authorization
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /authorization
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: GET
            Period: 60
            Stat: Sum

  Session4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-Session4XXApiGwErrorAlarm"
      AlarmDescription: !Sub "There has been a small proportion of 4XX errors on the Session endpoint. ${SupportManualURL}"
      ActionsEnabled: false   # alarm reviewed in production and decision made to disable
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 10
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: errorThreshold
          Label: errorThreshold
          ReturnData: true
          Expression: IF(invocations<3 || error<2,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /session
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /session
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  YotiCallback4XXApiGwErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-YotiCallback4XXApiGwErrorAlarm"
      AlarmDescription:
        Fn::Sub: >-
          >=50% of invocations to the YotiCallback endpoint have generated a 4XX error in
          4 or more out of the last 10 minutes. ${SupportManualURL}
      ActionsEnabled: true
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 10
      DatapointsToAlarm: 4
      Threshold: 50
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: safePercentage
          Label: safePercentage
          ReturnData: true
          Expression: IF(invocations<5 || error<5,0,errorPercentage)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /callback
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum
        - Id: errorPercentage
          Label: errorPercentage
          ReturnData: false
          Expression: (error/invocations)*100
        - Id: error
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: 4XXError
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
                - Name: Resource
                  Value: /callback
                - Name: Stage
                  Value: !Ref Environment
                - Name: Method
                  Value: POST
            Period: 60
            Stat: Sum

  LatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-apiGWLatencyAlarm"
      AlarmDescription: !Sub "There has been increased latency on backend api-gateway. ${SupportManualURL}"
      ActionsEnabled: false  # disabled until we're ready for alarm actions to fire
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      Dimensions: [ ]
      EvaluationPeriods: 5
      DatapointsToAlarm: 2
      Threshold: 2500
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: safeLatency
          Label: safeLatency
          ReturnData: true
          Expression: IF(invocations<10,0,maxLatency)
        - Id: invocations
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Count
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
            Period: 60
            Stat: Sum
        - Id: maxLatency
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApiGateway
              MetricName: Latency
              Dimensions:
                - Name: ApiName
                  Value: !Sub "${AWS::StackName} - F2F Credential Issuer Private API"
            Period: 60
            Stat: Maximum

  TXMASQSOldMessagesAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-TXMASQSOldMessagesAlarm"
      AlarmDescription: !Sub "Trigger an alarm when the age of the oldest TXMA message is 5 or more minutes. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ApproximateAgeOfOldestMessage
      Namespace: AWS/SQS
      Statistic: Maximum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt TxMASQSQueue.QueueName
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 300
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  TXMADLQMessagesVisibleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-TXMADLQMessagesVisibleAlarm"
      AlarmDescription: !Sub "Trigger an alarm when message gets added to TXMA DLQ. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Maximum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt TxMASQSQueueDeadLetterQueue.QueueName
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  GovNotifySQSOldMessagesAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-GovNotifySQSOldMessagesAlarm"
      AlarmDescription: !Sub "Trigger an alarm when the age of the oldest TXMA message is 5 or more minutes. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ApproximateAgeOfOldestMessage
      Namespace: AWS/SQS
      Statistic: Maximum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt GovNotifySQSQueue.QueueName
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 300
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  GovNotifyDLQMessagesVisibleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-GovNotifyDLQMessagesVisibleAlarm"
      AlarmDescription: !Sub "Trigger an alarm when message gets added to GovNotify DLQ. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Maximum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt GovNotifySQSQueueDeadLetterQueue.QueueName
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  YotiCallbackOldMessagesAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-YotiCallbackOldMessagesAlarm"
      AlarmDescription: !Sub "Trigger an alarm when the age of the oldest YotiCallback message is 5 or more minutes. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ApproximateAgeOfOldestMessage
      Namespace: AWS/SQS
      Statistic: Maximum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt YotiCallbackQueue.QueueName
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 300
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  YotiCallbackDLQMessagesVisibleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-YotiCallbackDLQMessagesVisibleAlarm"
      AlarmDescription: !Sub "Trigger an alarm when message gets added to YotiCallback DLQ. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Maximum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt YotiCallbackQueueDeadLetterQueue.QueueName
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  IPVCoreSQSOldMessagesAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-IPVCoreSQSOldMessagesAlarm"
      AlarmDescription: !Sub "Trigger an alarm when the age of the oldest TXMA message is 5 or more minutes. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ApproximateAgeOfOldestMessage
      Namespace: AWS/SQS
      Statistic: Maximum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt IPVCoreSQSQueue.QueueName
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 300
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  IPVCoreDLQMessagesVisibleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub "${AWS::StackName}-IPVCoreDLQMessagesVisibleAlarm"
      AlarmDescription: !Sub "Trigger an alarm when message gets added to IPVCore DLQ. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: [ ]
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Maximum
      Dimensions:
        - Name: QueueName
          Value: !GetAtt IPVCoreDeadLetterQueue.QueueName
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  LambdaTimeoutAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      OKActions:
        - !ImportValue platform-alarm-topic-slack-warning-alert
      InsufficientDataActions: []
      AlarmDescription: !Sub "Trigger the alarm if any lambda in the account timesout 5 times within 5 minutes. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-LambdaTimeoutAlarm"
      EvaluationPeriods: 5
      DatapointsToAlarm: 5
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: a1
          Label: AcumulatedLambdaTimeOuts
          ReturnData: true
          Expression: (b1 + c1 + d1 + e1) >= 0
        - Id: b1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Sub "${AWS::StackName}/TimeOutLogMessages"
              MetricName: VerifyAuthorizeLambdaTimeOut
            Period: 60
            Stat: Sum
        - Id: c1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Sub "${AWS::StackName}/TimeOutLogMessages"
              MetricName: UserInfoLambdaTimeOut
            Period: 60
            Stat: Sum
        - Id: d1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Sub "${AWS::StackName}/TimeOutLogMessages"
              MetricName: FetchBioTokenLambdaTimeOut
            Period: 60
            Stat: Sum
        - Id: e1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Sub "${AWS::StackName}/TimeOutLogMessages"
              MetricName: IssueAccessTokenLambdaTimeOut
            Period: 60
            Stat: Sum

  ConcurrencyAlarmDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: ApplyReservedConcurrency
    Properties:
      DashboardName: !Sub '${AWS::StackName}-Concurrency-Alarm-Overview'
      DashboardBody:
        Fn::Sub: >
          {
            "widgets": [
              {
                "height": 6,
                  "width": 12,
                  "y": 0,
                  "x": 0,
                  "type": "metric",
                  "properties": {
                    "title": "session 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${SessionConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 0,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "Token 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${TokenConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 6,
                  "x": 0,
                  "type": "metric",
                  "properties": {
                    "title": "Authorization 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${AuthorizationConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 6,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "Document Selection 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${DocumentSelectionConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 0,
                  "type": "metric",
                  "properties": {
                    "title": "json Webkeys 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${JsonWebKeysConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "GovNotify 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${GovNotifyConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 18,
                  "x": 0,
                  "type": "metric",
                  "properties": {
                    "title": "UserInfo 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${UserInfoConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 18,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "Yoticallback 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${YotiCallbackConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                { "height": 6,
                  "width": 12,
                  "y": 18,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "TriggerYotiCallbackStateMachine 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${TriggerYotiConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                { "height": 6,
                  "width": 12,
                  "y": 18,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "ThankYouEmail 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${ThankYouEmailConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                { "height": 6,
                  "width": 12,
                  "y": 18,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "ReminderEmail 80% Concurrency - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${ReminderEmailConcurrency80Alarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                }
              ]
            }

  ThrottlesAlarmDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: DeployAlarms
    Properties:
      DashboardName: !Sub '${AWS::StackName}-Throttles-Alarm-Overview'
      DashboardBody:
        Fn::Sub: >
          {
            "widgets": [
                {
                  "height": 6,
                  "width": 12,
                  "y": 0,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "Session Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${SessionThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 6,
                  "x": 0,
                  "type": "metric",
                  "properties": {
                    "title": "TokenThrottleAlarm - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${TokenThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 6,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "User Info Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${UserInfoThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 0,
                  "type": "metric",
                  "properties": {
                    "title": "Authorization Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${AuthorizationThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 0,
                  "type": "metric",
                  "properties": {
                    "title": "Document Selection Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${DocumentSelectionThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "json web keys Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${JsonWebKeysThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 18,
                  "x": 0,
                  "type": "metric",
                  "properties": {
                    "title": "User Info Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${UserInfoThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "Yoticallback Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${YotiCallbackThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "TriggerYoti Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${TriggerYotiThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "ReminderEmail Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${ReminderEmailThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                },
                {
                  "height": 6,
                  "width": 12,
                  "y": 12,
                  "x": 12,
                  "type": "metric",
                  "properties": {
                    "title": "ThankYouEmail Throttles - ${AWS::StackName}",
                    "annotations": {
                      "alarms": ["${ThankYouEmailThrottleAlarm.Arn}"]
                    },
                    "view": "timeSeries",
                    "stacked": false
                  }
                }
              ]
            }

  CriticalAlarmDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: DeployAlarms
    Properties:
      DashboardName: !Sub '${AWS::StackName}-Critical-Alarm-Overview'
      DashboardBody:
        Fn::Sub: >
          {
          "widgets": [
              {
                "height": 6,
                "width": 12,
                "y": 6,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "API Gateway 5XX critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${5XXErrorCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "DocumentSelection 5XX critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${DocumentSelection5XXApiGwErrorCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "userInfo 5XX critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${UserInfo5XXApiGwErrorCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "Token 5XX critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Token5XXApiGwErrorCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "Authorization 5XX critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Authorization5XXApiGwErrorCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "Session 5XX critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Session5XXApiGwErrorCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "JsonWebKeys 5XX critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${JsonWebKeys5XXApiGwErrorCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "YotiCallback 5XX critical - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${YotiCallback5XXApiGwErrorCriticalAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              }
            ]
          }

  WarningAlarmDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: DeployAlarms
    Properties:
      DashboardName: !Sub '${AWS::StackName}-Warning-Alarm-Overview'
      DashboardBody:
        Fn::Sub: >
          {
            "widgets": [
              {
                "height": 6,
                "width": 12,
                "y": 0,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "Latency Alarm - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${LatencyAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 6,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "5XX Error Alarm - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${5XXErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 12,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "DocumentSelection 5XX ApiGw Error - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${DocumentSelection5XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 18,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "userInfo 5XX ApiGw Error - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${UserInfo5XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 24,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "Token 5XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Token5XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 24,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "Authorization 5XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Authorization5XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 30,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "Session 5XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Session5XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 30,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "Json Web Keys 5XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${JsonWebKeys5XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 36,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "Yoticallback 5XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${YotiCallback5XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 36,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "DocumentSelection 4XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${DocumentSelection4XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 42,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "UserInfo 4XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${UserInfo4XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 42,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "Token 4XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Token4XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 48,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "Authorization 4XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Authorization4XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 48,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "Session 4XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${Session4XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 54,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "Yoticallback 4XX - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${YotiCallback4XXApiGwErrorAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 66,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "TXMA SQS Old Messages - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${TXMASQSOldMessagesAlarm.Arn}"]
                     },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 66,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "TXMA DLQ Messages Visible - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${TXMADLQMessagesVisibleAlarm.Arn}"]
                     },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 72,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "GovNotify SQS Old Messages - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${GovNotifySQSOldMessagesAlarm.Arn}"]
                     },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 78,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "GovNotify DLQ Messages Visible - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${GovNotifyDLQMessagesVisibleAlarm.Arn}"]
                     },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 78,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "YotiCallback SQS Old Messages - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${YotiCallbackOldMessagesAlarm.Arn}"]
                     },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 84,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "YotiCallback DLQ Messages Visible - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${YotiCallbackDLQMessagesVisibleAlarm.Arn}"]
                     },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 90,
                "x": 0,
                "type": "metric",
                "properties": {
                  "title": "IPVCore SQS Old Messages - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${IPVCoreSQSOldMessagesAlarm.Arn}"]
                  },
                  "view": "timeSeries",
                  "stacked": false
                }
              },
              {
                "height": 6,
                "width": 12,
                "y": 90,
                "x": 12,
                "type": "metric",
                "properties": {
                  "title": "IPVCore DLQ Messages Visible - ${AWS::StackName}",
                  "annotations": {
                    "alarms": ["${IPVCoreDLQMessagesVisibleAlarm.Arn}"]
                     },
                  "view": "timeSeries",
                  "stacked": false
                }
              }
            ]
          }



Outputs:
  F2FApiGatewayId:
    Description: "API GatewayID of the F2F CRI API"
    Value: !Sub "${F2FRestApi}"
    Export:
      Name: !Sub ${AWS::StackName}-F2FApiGatewayId
  F2FBackendURL:
    Description: "F2F Backend URL"
    Value: !Sub
      - "https://${CustomDomainName}"
      - CustomDomainName: !Ref F2FApiCustomDomainName
    Export:
      Name: !Sub ${AWS::StackName}-F2FBackendURL
  F2FIPVStubExecuteURL:
    Condition: IsNotProdLikeEnvironment
    Description: "F2F IPV Stub"
    Value:
      Fn::ImportValue: !Sub '${IPVStubStackName}-IPVStubExecuteUrl'
  F2FYotiStubURL:
    Condition: IsNotProdLikeEnvironment
    Description: "F2F Yoti Stub"
    Value: !FindInMap [EnvironmentVariables, !Ref Environment, YOTIBASEURL]
  TxMASQSQueue:
    Description: "Arn of the TxMASQSQueue"
    Value: !GetAtt TxMASQSQueue.Arn
    Export:
      Name: !Sub ${AWS::StackName}-TxMASQSQueue-arn
  TxMAKMSEncryptionKey:
    Description: "Arn of the TxMAKMSEncryptionKey"
    Value: !GetAtt TxMAKMSEncryptionKey.Arn
    Export:
      Name: !Sub ${AWS::StackName}-TxMAKMSEncryptionKey-arn
  IPVCoreSQSQueue:
    Description: "Arn of the IPVCoreSQSQueue"
    Value: !GetAtt IPVCoreSQSQueue.Arn
    Export:
      Name: !Sub ${AWS::StackName}-IPVCoreSQSQueue-arn
  IPVCoreQueueEncryptionKey:
    Description: "Arn of the IPVCoreQueueEncryptionKey"
    Value: !GetAtt IPVCoreQueueEncryptionKey.Arn
    Export:
      Name: !Sub ${AWS::StackName}-IPVCoreQueueEncryptionKey-arn
  SessionTableName:
    Description: "Name of the Session DynamoDB table"
    Value:
      Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-name"
    Export:
      Name: !Sub ${AWS::StackName}-SessionTable-name
  SessionTableARN:
    Description: "Arn of the Session DynamoDB table"
    Value:
      Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-arn"
    Export:
      Name: !Sub ${AWS::StackName}-SessionTable-arn
  SessionTableEcryptionARN:
    Description: "Arn of the SessionTableEncryptionKey"
    Value:
      Fn::ImportValue: !Sub "${L2DynamoStackName}-session-table-key-arn"
    Export:
      Name: !Sub ${AWS::StackName}-SessionTableEncryptionKey-arn
  PersonIdentityTableName:
    Description: "Name of the Person Identity DynamoDB table"
    Value:
      Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-name"
    Export:
      Name: !Sub ${AWS::StackName}-PersonIdentityTable-name
  PersonIdentityTableARN:
    Description: "Arn of the Person Identity DynamoDB table"
    Value:
      Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-arn"
    Export:
      Name: !Sub ${AWS::StackName}-PersonIdentityTable-arn
  PersonIdentityTableEncryptionARN:
    Description: "Arn of the PersonTableEncryptionKey"
    Value:
      Fn::ImportValue: !Sub "${L2DynamoStackName}-person-identity-table-key-arn"
    Export:
      Name: !Sub ${AWS::StackName}-PersonIdentityTableEncryptionKey-arn
  F2FTestHarnessURL:
    Condition: IsNotProdLikeEnvironment
    Description: "F2F Test Harness"
    Value: !FindInMap [EnvironmentVariables, !Ref Environment, TESTHARNESSURL]
  DNSSuffix:
    Condition: IsNotProdLikeEnvironment
    Description: "F2F DNS Suffix"
    Value: !FindInMap [EnvironmentVariables, !Ref Environment, DNSSUFFIX]
  F2FPostOfficeStubURL:
    Condition: IsNotProdLikeEnvironment
    Description: "F2F Post Office Stub API"
    Value: !FindInMap [EnvironmentVariables, !Ref Environment, POSTOFFICESTUBAPI]
  VcSigningKeyId:
    Condition: IsNotProdLikeEnvironment
    Description: "Signing Key used to sign VC"
    Value:
      Fn::ImportValue: !Sub "${L2KMSStackName}-vc-signing-key-id"
  ExpiredSessionsLambdaName:
    Condition: IsNotProdLikeEnvironment
    Description: "Lambda Service to process expired user sessions"
    Value: !Ref ExpiredSessionsFunction
  YotiLetterBucketArn:
    Condition: IsNotProdLikeEnvironment
    Description: "ARN of the Yoti Letter Bucket"
    Value: !GetAtt YotiLetterBucket.Arn
    Export:
      Name: !Sub ${AWS::StackName}-YotiLetterBucketArn